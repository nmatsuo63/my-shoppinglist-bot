"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable: no-console
// tslint:disable: max-line-length
/* eslint-disable @typescript-eslint/no-require-imports */
const cfnResponse = require("../../lib/provider-framework/runtime/cfn-response");
const framework = require("../../lib/provider-framework/runtime/framework");
const outbound = require("../../lib/provider-framework/runtime/outbound");
const mocks = require("./mocks");
/* eslint-enable */
console.log = jest.fn();
cfnResponse.includeStackTraces = false;
const MOCK_PHYSICAL_ID = 'mock-physical-resource-id';
const MOCK_PROPS = { Name: 'Value', List: ['1', '2', '3'], ServiceToken: 'bla' };
const MOCK_ATTRS = { MyAttribute: 'my-mock-attribute' };
outbound.httpRequest = mocks.httpRequestMock;
outbound.invokeFunction = mocks.invokeFunctionMock;
outbound.startExecution = mocks.startExecutionMock;
beforeEach(() => mocks.setup());
test('async flow: isComplete returns true only after 3 times', async () => {
    let isCompleteCalls = 0;
    mocks.onEventImplMock = async (event) => {
        expect(event.RequestType).toEqual('Create');
        expect(event.ResourceProperties).toStrictEqual(MOCK_PROPS);
        expect(event.PhysicalResourceId).toBeUndefined(); // physical ID in CREATE
        return {
            PhysicalResourceId: MOCK_PHYSICAL_ID,
            Data: MOCK_ATTRS
        };
    };
    mocks.isCompleteImplMock = async (event) => {
        isCompleteCalls++;
        expect(event.PhysicalResourceId).toEqual(MOCK_PHYSICAL_ID); // physical ID returned from onEvent is passed to "isComplete"
        expect(event.Data).toStrictEqual(MOCK_ATTRS); // attributes are propagated between the calls
        const result = isCompleteCalls === 3;
        if (!result) {
            return {
                IsComplete: false
            };
        }
        return {
            IsComplete: true,
            Data: {
                Additional: 'attribute' // additional attributes can be returned from "isComplete"
            }
        };
    };
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
        ResourceProperties: MOCK_PROPS
    });
    // THEN
    expect(isCompleteCalls).toEqual(3);
    expectCloudFormationSuccess({
        PhysicalResourceId: MOCK_PHYSICAL_ID,
        Data: {
            ...MOCK_ATTRS,
            Additional: 'attribute'
        },
    });
});
test('isComplete throws in the first invocation', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ PhysicalResourceId: MOCK_PHYSICAL_ID, });
    mocks.isCompleteImplMock = async () => { throw new Error('Some failure'); };
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
        ResourceProperties: MOCK_PROPS
    });
    expectCloudFormationFailed('Some failure');
});
test('fails gracefully if "onEvent" throws an error', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => { throw new Error('error thrown during onEvent'); };
    mocks.isCompleteImplMock = async () => ({ IsComplete: true });
    // WHEN
    await simulateEvent({
        RequestType: 'Create'
    });
    // THEN
    expectCloudFormationFailed('error thrown during onEvent');
    expectNoWaiter();
});
describe('PhysicalResourceId', () => {
    describe('if not omitted from onEvent result', () => {
        it('defaults to RequestId for CREATE', async () => {
            // WHEN
            mocks.onEventImplMock = async () => undefined;
            // THEN
            await simulateEvent({
                RequestType: 'Create'
            });
            expectCloudFormationSuccess({
                PhysicalResourceId: mocks.MOCK_REQUEST.RequestId
            });
        });
        it('defaults to the current PhysicalResourceId for UPDATE', async () => {
            // WHEN
            mocks.onEventImplMock = async () => undefined;
            // THEN
            await simulateEvent({
                RequestType: 'Update',
                PhysicalResourceId: MOCK_PHYSICAL_ID
            });
            expectCloudFormationSuccess({
                PhysicalResourceId: MOCK_PHYSICAL_ID
            });
        });
        it('defaults to the current PhysicalResourceId for DELETE', async () => {
            // WHEN
            mocks.onEventImplMock = async () => undefined;
            // THEN
            await simulateEvent({
                RequestType: 'Delete',
                PhysicalResourceId: MOCK_PHYSICAL_ID
            });
            expectCloudFormationSuccess({
                PhysicalResourceId: MOCK_PHYSICAL_ID
            });
        });
    });
    test('UPDATE: can change the physical ID by returning a new ID', async () => {
        // GIVEN
        mocks.onEventImplMock = async () => ({ PhysicalResourceId: 'NewPhysicalId' });
        mocks.isCompleteImplMock = async () => ({ IsComplete: true });
        // WHEN
        await simulateEvent({
            RequestType: 'Update',
            PhysicalResourceId: 'CurrentPhysicalId'
        });
        // THEN
        expectCloudFormationSuccess({
            PhysicalResourceId: 'NewPhysicalId'
        });
    });
    test('DELETE: cannot change the physical resource ID during a delete', async () => {
        // GIVEN
        mocks.onEventImplMock = async () => ({ PhysicalResourceId: 'NewPhysicalId' });
        mocks.isCompleteImplMock = async () => ({ IsComplete: true });
        // WHEN
        await simulateEvent({
            RequestType: 'Delete',
            PhysicalResourceId: 'CurrentPhysicalId'
        });
        // THEN
        expectNoWaiter();
        expectCloudFormationFailed('DELETE: cannot change the physical resource ID from "CurrentPhysicalId" to "NewPhysicalId" during deletion');
    });
});
test('isComplete always returns "false" and then a timeout occurs', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ Data: { Foo: 123 }, PhysicalResourceId: MOCK_PHYSICAL_ID });
    mocks.isCompleteImplMock = async () => ({ IsComplete: false });
    // WHEN
    await simulateEvent({
        RequestType: 'Update',
        PhysicalResourceId: MOCK_PHYSICAL_ID
    });
    // THEN
    expectCloudFormationFailed('Operation timed out');
});
test('isComplete: "Data" is not allowed if InComplete is "False"', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ Data: { Foo: 123 }, PhysicalResourceId: MOCK_PHYSICAL_ID });
    mocks.isCompleteImplMock = async () => ({ IsComplete: false, Data: { Foo: 3333 } });
    // WHEN
    await simulateEvent({
        RequestType: 'Update',
        PhysicalResourceId: MOCK_PHYSICAL_ID
    });
    expectCloudFormationFailed('"Data" is not allowed if "IsComplete" is "False"');
});
test('if there is no user-defined "isComplete", the waiter will not be triggered or needed', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ PhysicalResourceId: MOCK_PHYSICAL_ID });
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
    });
    // THEN
    expectNoWaiter();
    expectCloudFormationSuccess({ PhysicalResourceId: MOCK_PHYSICAL_ID });
});
test('fails if user handler returns a non-object response', async () => {
    // GIVEN
    mocks.stringifyPayload = false;
    mocks.onEventImplMock = async () => 'string';
    // WHEN
    await simulateEvent({ RequestType: 'Create' });
    // THEN
    expectCloudFormationFailed('return values from user-handlers must be JSON objects. got: \"string\"');
});
describe('if CREATE fails, the subsequent DELETE will be ignored', () => {
    it('FAILED response sets PhysicalResourceId to a special marker', async () => {
        // WHEN
        mocks.onEventImplMock = async () => { throw new Error('CREATE FAILED'); };
        // THEN
        await simulateEvent({
            RequestType: 'Create'
        });
        expectCloudFormationFailed('CREATE FAILED', {
            PhysicalResourceId: cfnResponse.CREATE_FAILED_PHYSICAL_ID_MARKER,
        });
    });
    it('DELETE request with the marker succeeds without calling user handler', async () => {
        // GIVEN
        // user handler is not assigned
        // WHEN
        await simulateEvent({
            RequestType: 'Delete',
            PhysicalResourceId: cfnResponse.CREATE_FAILED_PHYSICAL_ID_MARKER
        });
        // THEN
        expectCloudFormationSuccess();
    });
});
// -----------------------------------------------------------------------------------------------------------------------
/**
 * Triggers the custom resource lifecycle event flow by invoking the framework's
 * onEvent function and then, if the waiter state machine was started, simulates
 * the waiter and invokes isComplete and onTimeout as appropriate.
 */
async function simulateEvent(req) {
    const x = {
        ServiceToken: 'SERVICE-TOKEN',
        ResponseURL: mocks.MOCK_REQUEST.ResponseURL,
        StackId: mocks.MOCK_REQUEST.StackId,
        RequestId: mocks.MOCK_REQUEST.RequestId,
        ResourceType: 'Custom::TestResource',
        LogicalResourceId: mocks.MOCK_REQUEST.LogicalResourceId,
        ...req
    };
    mocks.prepareForExecution();
    await framework.onEvent(x);
    // if the FSM
    if (mocks.startStateMachineInput && mocks.startStateMachineInput.stateMachineArn === mocks.MOCK_SFN_ARN) {
        await simulateWaiter(JSON.parse(mocks.startStateMachineInput.input));
    }
    async function simulateWaiter(event) {
        let retry = true;
        let count = 5;
        while (retry) {
            try {
                await framework.isComplete(event);
                retry = false;
            }
            catch (e) {
                if (e instanceof cfnResponse.Retry) {
                    if (count-- === 0) {
                        await framework.onTimeout({ Cause: JSON.stringify({ errorMessage: e.message }) });
                        retry = false;
                    }
                    else {
                        retry = true;
                        continue;
                    }
                }
                else {
                    throw new Error(e);
                }
            }
        }
    }
}
function expectCloudFormationFailed(expectedReason, resp) {
    expectCloudFormationResponse({
        Status: 'FAILED',
        Reason: expectedReason,
        ...resp
    });
}
function expectCloudFormationSuccess(resp) {
    if (mocks.cfnResponse.Status !== 'SUCCESS') {
        console.error(mocks.cfnResponse.Reason || '<NO REASON>');
    }
    expectCloudFormationResponse({ Status: 'SUCCESS', ...resp });
}
function expectCloudFormationResponse(resp = {}) {
    for (const [key, expected] of Object.entries(resp)) {
        const actual = mocks.cfnResponse[key];
        expect(actual).toStrictEqual(expected);
    }
}
function expectNoWaiter() {
    expect(mocks.startStateMachineInput).toBeUndefined();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVudGltZS50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicnVudGltZS50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQTZCO0FBQzdCLGtDQUFrQztBQUNsQywwREFBMEQ7QUFDMUQsaUZBQWtGO0FBQ2xGLDRFQUE2RTtBQUM3RSwwRUFBMkU7QUFDM0UsaUNBQWtDO0FBQ2xDLG1CQUFtQjtBQUVuQixPQUFPLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUV4QixXQUFXLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDO0FBRXZDLE1BQU0sZ0JBQWdCLEdBQUcsMkJBQTJCLENBQUM7QUFDckQsTUFBTSxVQUFVLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxDQUFDO0FBQ2pGLE1BQU0sVUFBVSxHQUFHLEVBQUUsV0FBVyxFQUFFLG1CQUFtQixFQUFFLENBQUM7QUFFeEQsUUFBUSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsZUFBZSxDQUFDO0FBQzdDLFFBQVEsQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDLGtCQUFrQixDQUFDO0FBQ25ELFFBQVEsQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDLGtCQUFrQixDQUFDO0FBRW5ELFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztBQUVoQyxJQUFJLENBQUMsd0RBQXdELEVBQUUsS0FBSyxJQUFJLEVBQUU7SUFDeEUsSUFBSSxlQUFlLEdBQUcsQ0FBQyxDQUFDO0lBRXhCLEtBQUssQ0FBQyxlQUFlLEdBQUcsS0FBSyxFQUFDLEtBQUssRUFBQyxFQUFFO1FBQ3BDLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxD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QUFRLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ2xELE1BQU0sTUFBTSxHQUFJLEtBQUssQ0FBQyxXQUFtQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9DLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBZSxDQUFDLENBQUM7S0FDL0M7QUFDSCxDQUFDO0FBRUQsU0FBUyxjQUFjO0lBQ3JCLE1BQU0sQ0FBQyxLQUFLLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUN2RCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHNsaW50OmRpc2FibGU6IG5vLWNvbnNvbGVcbi8vIHRzbGludDpkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGhcbi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby1yZXF1aXJlLWltcG9ydHMgKi9cbmltcG9ydCBjZm5SZXNwb25zZSA9IHJlcXVpcmUoJy4uLy4uL2xpYi9wcm92aWRlci1mcmFtZXdvcmsvcnVudGltZS9jZm4tcmVzcG9uc2UnKTtcbmltcG9ydCBmcmFtZXdvcmsgPSByZXF1aXJlKCcuLi8uLi9saWIvcHJvdmlkZXItZnJhbWV3b3JrL3J1bnRpbWUvZnJhbWV3b3JrJyk7XG5pbXBvcnQgb3V0Ym91bmQgPSByZXF1aXJlKCcuLi8uLi9saWIvcHJvdmlkZXItZnJhbWV3b3JrL3J1bnRpbWUvb3V0Ym91bmQnKTtcbmltcG9ydCBtb2NrcyA9IHJlcXVpcmUoJy4vbW9ja3MnKTtcbi8qIGVzbGludC1lbmFibGUgKi9cblxuY29uc29sZS5sb2cgPSBqZXN0LmZuKCk7XG5cbmNmblJlc3BvbnNlLmluY2x1ZGVTdGFja1RyYWNlcyA9IGZhbHNlO1xuXG5jb25zdCBNT0NLX1BIWVNJQ0FMX0lEID0gJ21vY2stcGh5c2ljYWwtcmVzb3VyY2UtaWQnO1xuY29uc3QgTU9DS19QUk9QUyA9IHsgTmFtZTogJ1ZhbHVlJywgTGlzdDogWycxJywgJzInLCAnMyddLCBTZXJ2aWNlVG9rZW46ICdibGEnIH07XG5jb25zdCBNT0NLX0FUVFJTID0geyBNeUF0dHJpYnV0ZTogJ215LW1vY2stYXR0cmlidXRlJyB9O1xuXG5vdXRib3VuZC5odHRwUmVxdWVzdCA9IG1vY2tzLmh0dHBSZXF1ZXN0TW9jaztcbm91dGJvdW5kLmludm9rZUZ1bmN0aW9uID0gbW9ja3MuaW52b2tlRnVuY3Rpb25Nb2NrO1xub3V0Ym91bmQuc3RhcnRFeGVjdXRpb24gPSBtb2Nrcy5zdGFydEV4ZWN1dGlvbk1vY2s7XG5cbmJlZm9yZUVhY2goKCkgPT4gbW9ja3Muc2V0dXAoKSk7XG5cbnRlc3QoJ2FzeW5jIGZsb3c6IGlzQ29tcGxldGUgcmV0dXJucyB0cnVlIG9ubHkgYWZ0ZXIgMyB0aW1lcycsIGFzeW5jICgpID0+IHtcbiAgbGV0IGlzQ29tcGxldGVDYWxscyA9IDA7XG5cbiAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgZXZlbnQgPT4ge1xuICAgIGV4cGVjdChldmVudC5SZXF1ZXN0VHlwZSkudG9FcXVhbCgnQ3JlYXRlJyk7XG4gICAgZXhwZWN0KGV2ZW50LlJlc291cmNlUHJvcGVydGllcykudG9TdHJpY3RFcXVhbChNT0NLX1BST1BTKTtcbiAgICBleHBlY3QoZXZlbnQuUGh5c2ljYWxSZXNvdXJjZUlkKS50b0JlVW5kZWZpbmVkKCk7IC8vIHBoeXNpY2FsIElEIGluIENSRUFURVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCxcbiAgICAgIERhdGE6IE1PQ0tfQVRUUlNcbiAgICB9O1xuICB9O1xuXG4gIG1vY2tzLmlzQ29tcGxldGVJbXBsTW9jayA9IGFzeW5jIGV2ZW50ID0+IHtcbiAgICBpc0NvbXBsZXRlQ2FsbHMrKztcbiAgICBleHBlY3QoZXZlbnQuUGh5c2ljYWxSZXNvdXJjZUlkKS50b0VxdWFsKE1PQ0tfUEhZU0lDQUxfSUQpOyAvLyBwaHlzaWNhbCBJRCByZXR1cm5lZCBmcm9tIG9uRXZlbnQgaXMgcGFzc2VkIHRvIFwiaXNDb21wbGV0ZVwiXG4gICAgZXhwZWN0KGV2ZW50LkRhdGEpLnRvU3RyaWN0RXF1YWwoTU9DS19BVFRSUyk7IC8vIGF0dHJpYnV0ZXMgYXJlIHByb3BhZ2F0ZWQgYmV0d2VlbiB0aGUgY2FsbHNcblxuICAgIGNvbnN0IHJlc3VsdCA9IGlzQ29tcGxldGVDYWxscyA9PT0gMztcbiAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgSXNDb21wbGV0ZTogZmFsc2VcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIElzQ29tcGxldGU6IHRydWUsXG4gICAgICBEYXRhOiB7XG4gICAgICAgIEFkZGl0aW9uYWw6ICdhdHRyaWJ1dGUnIC8vIGFkZGl0aW9uYWwgYXR0cmlidXRlcyBjYW4gYmUgcmV0dXJuZWQgZnJvbSBcImlzQ29tcGxldGVcIlxuICAgICAgfVxuICAgIH07XG4gIH07XG5cbiAgLy8gV0hFTlxuICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gICAgUmVzb3VyY2VQcm9wZXJ0aWVzOiBNT0NLX1BST1BTXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KGlzQ29tcGxldGVDYWxscykudG9FcXVhbCgzKTtcblxuICBleHBlY3RDbG91ZEZvcm1hdGlvblN1Y2Nlc3Moe1xuICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCxcbiAgICBEYXRhOiB7XG4gICAgICAuLi5NT0NLX0FUVFJTLFxuICAgICAgQWRkaXRpb25hbDogJ2F0dHJpYnV0ZSdcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdpc0NvbXBsZXRlIHRocm93cyBpbiB0aGUgZmlyc3QgaW52b2NhdGlvbicsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lELCB9KTtcbiAgbW9ja3MuaXNDb21wbGV0ZUltcGxNb2NrID0gYXN5bmMgKCkgPT4geyB0aHJvdyBuZXcgRXJyb3IoJ1NvbWUgZmFpbHVyZScpOyB9O1xuXG4gIC8vIFdIRU5cbiAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgUmVxdWVzdFR5cGU6ICdDcmVhdGUnLFxuICAgIFJlc291cmNlUHJvcGVydGllczogTU9DS19QUk9QU1xuICB9KTtcblxuICBleHBlY3RDbG91ZEZvcm1hdGlvbkZhaWxlZCgnU29tZSBmYWlsdXJlJyk7XG59KTtcblxudGVzdCgnZmFpbHMgZ3JhY2VmdWxseSBpZiBcIm9uRXZlbnRcIiB0aHJvd3MgYW4gZXJyb3InLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+IHsgdGhyb3cgbmV3IEVycm9yKCdlcnJvciB0aHJvd24gZHVyaW5nIG9uRXZlbnQnKTsgfTtcbiAgbW9ja3MuaXNDb21wbGV0ZUltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgSXNDb21wbGV0ZTogdHJ1ZSB9KTtcblxuICAvLyBXSEVOXG4gIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgIFJlcXVlc3RUeXBlOiAnQ3JlYXRlJ1xuICB9KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uRmFpbGVkKCdlcnJvciB0aHJvd24gZHVyaW5nIG9uRXZlbnQnKTtcbiAgZXhwZWN0Tm9XYWl0ZXIoKTtcbn0pO1xuXG5kZXNjcmliZSgnUGh5c2ljYWxSZXNvdXJjZUlkJywgKCkgPT4ge1xuXG4gIGRlc2NyaWJlKCdpZiBub3Qgb21pdHRlZCBmcm9tIG9uRXZlbnQgcmVzdWx0JywgKCkgPT4ge1xuXG4gICAgaXQoJ2RlZmF1bHRzIHRvIFJlcXVlc3RJZCBmb3IgQ1JFQVRFJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gV0hFTlxuICAgICAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgKCkgPT4gdW5kZWZpbmVkO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICAgICAgUmVxdWVzdFR5cGU6ICdDcmVhdGUnXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0Q2xvdWRGb3JtYXRpb25TdWNjZXNzKHtcbiAgICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBtb2Nrcy5NT0NLX1JFUVVFU1QuUmVxdWVzdElkXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdkZWZhdWx0cyB0byB0aGUgY3VycmVudCBQaHlzaWNhbFJlc291cmNlSWQgZm9yIFVQREFURScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFdIRU5cbiAgICAgIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+IHVuZGVmaW5lZDtcblxuICAgICAgLy8gVEhFTlxuICAgICAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgICAgIFJlcXVlc3RUeXBlOiAnVXBkYXRlJyxcbiAgICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lEXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0Q2xvdWRGb3JtYXRpb25TdWNjZXNzKHtcbiAgICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lEXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdkZWZhdWx0cyB0byB0aGUgY3VycmVudCBQaHlzaWNhbFJlc291cmNlSWQgZm9yIERFTEVURScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFdIRU5cbiAgICAgIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+IHVuZGVmaW5lZDtcblxuICAgICAgLy8gVEhFTlxuICAgICAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgICAgIFJlcXVlc3RUeXBlOiAnRGVsZXRlJyxcbiAgICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lEXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0Q2xvdWRGb3JtYXRpb25TdWNjZXNzKHtcbiAgICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lEXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnVVBEQVRFOiBjYW4gY2hhbmdlIHRoZSBwaHlzaWNhbCBJRCBieSByZXR1cm5pbmcgYSBuZXcgSUQnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiAoeyBQaHlzaWNhbFJlc291cmNlSWQ6ICdOZXdQaHlzaWNhbElkJyB9KTtcbiAgICBtb2Nrcy5pc0NvbXBsZXRlSW1wbE1vY2sgPSBhc3luYyAoKSA9PiAoeyBJc0NvbXBsZXRlOiB0cnVlIH0pO1xuXG4gICAgLy8gV0hFTlxuICAgIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgICAgUmVxdWVzdFR5cGU6ICdVcGRhdGUnLFxuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiAnQ3VycmVudFBoeXNpY2FsSWQnXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0Q2xvdWRGb3JtYXRpb25TdWNjZXNzKHtcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogJ05ld1BoeXNpY2FsSWQnXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ0RFTEVURTogY2Fubm90IGNoYW5nZSB0aGUgcGh5c2ljYWwgcmVzb3VyY2UgSUQgZHVyaW5nIGEgZGVsZXRlJywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgUGh5c2ljYWxSZXNvdXJjZUlkOiAnTmV3UGh5c2ljYWxJZCcgfSk7XG4gICAgbW9ja3MuaXNDb21wbGV0ZUltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgSXNDb21wbGV0ZTogdHJ1ZSB9KTtcblxuICAgIC8vIFdIRU5cbiAgICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICAgIFJlcXVlc3RUeXBlOiAnRGVsZXRlJyxcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogJ0N1cnJlbnRQaHlzaWNhbElkJ1xuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdE5vV2FpdGVyKCk7XG4gICAgZXhwZWN0Q2xvdWRGb3JtYXRpb25GYWlsZWQoJ0RFTEVURTogY2Fubm90IGNoYW5nZSB0aGUgcGh5c2ljYWwgcmVzb3VyY2UgSUQgZnJvbSBcIkN1cnJlbnRQaHlzaWNhbElkXCIgdG8gXCJOZXdQaHlzaWNhbElkXCIgZHVyaW5nIGRlbGV0aW9uJyk7XG4gIH0pO1xuXG59KTtcblxudGVzdCgnaXNDb21wbGV0ZSBhbHdheXMgcmV0dXJucyBcImZhbHNlXCIgYW5kIHRoZW4gYSB0aW1lb3V0IG9jY3VycycsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgRGF0YTogeyBGb286IDEyMyB9LCBQaHlzaWNhbFJlc291cmNlSWQ6IE1PQ0tfUEhZU0lDQUxfSUQgfSk7XG4gIG1vY2tzLmlzQ29tcGxldGVJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IElzQ29tcGxldGU6IGZhbHNlIH0pO1xuXG4gIC8vIFdIRU5cbiAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgUmVxdWVzdFR5cGU6ICdVcGRhdGUnLFxuICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRFxuICB9KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uRmFpbGVkKCdPcGVyYXRpb24gdGltZWQgb3V0Jyk7XG59KTtcblxudGVzdCgnaXNDb21wbGV0ZTogXCJEYXRhXCIgaXMgbm90IGFsbG93ZWQgaWYgSW5Db21wbGV0ZSBpcyBcIkZhbHNlXCInLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IERhdGE6IHsgRm9vOiAxMjMgfSwgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lEIH0pO1xuICBtb2Nrcy5pc0NvbXBsZXRlSW1wbE1vY2sgPSBhc3luYyAoKSA9PiAoeyBJc0NvbXBsZXRlOiBmYWxzZSwgRGF0YTogeyBGb286IDMzMzMgfSB9KTtcblxuICAvLyBXSEVOXG4gIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgIFJlcXVlc3RUeXBlOiAnVXBkYXRlJyxcbiAgICBQaHlzaWNhbFJlc291cmNlSWQ6IE1PQ0tfUEhZU0lDQUxfSURcbiAgfSk7XG5cbiAgZXhwZWN0Q2xvdWRGb3JtYXRpb25GYWlsZWQoJ1wiRGF0YVwiIGlzIG5vdCBhbGxvd2VkIGlmIFwiSXNDb21wbGV0ZVwiIGlzIFwiRmFsc2VcIicpO1xufSk7XG5cbnRlc3QoJ2lmIHRoZXJlIGlzIG5vIHVzZXItZGVmaW5lZCBcImlzQ29tcGxldGVcIiwgdGhlIHdhaXRlciB3aWxsIG5vdCBiZSB0cmlnZ2VyZWQgb3IgbmVlZGVkJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiAoeyBQaHlzaWNhbFJlc291cmNlSWQ6IE1PQ0tfUEhZU0lDQUxfSUQgfSk7XG5cbiAgLy8gV0hFTlxuICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0Tm9XYWl0ZXIoKTtcbiAgZXhwZWN0Q2xvdWRGb3JtYXRpb25TdWNjZXNzKHsgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lEIH0pO1xufSk7XG5cbnRlc3QoJ2ZhaWxzIGlmIHVzZXIgaGFuZGxlciByZXR1cm5zIGEgbm9uLW9iamVjdCByZXNwb25zZScsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbW9ja3Muc3RyaW5naWZ5UGF5bG9hZCA9IGZhbHNlO1xuICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiAnc3RyaW5nJyBhcyBhbnk7XG5cbiAgLy8gV0hFTlxuICBhd2FpdCBzaW11bGF0ZUV2ZW50KHsgUmVxdWVzdFR5cGU6ICdDcmVhdGUnIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0Q2xvdWRGb3JtYXRpb25GYWlsZWQoJ3JldHVybiB2YWx1ZXMgZnJvbSB1c2VyLWhhbmRsZXJzIG11c3QgYmUgSlNPTiBvYmplY3RzLiBnb3Q6IFxcXCJzdHJpbmdcXFwiJyk7XG59KTtcblxuZGVzY3JpYmUoJ2lmIENSRUFURSBmYWlscywgdGhlIHN1YnNlcXVlbnQgREVMRVRFIHdpbGwgYmUgaWdub3JlZCcsICgpID0+IHtcblxuICBpdCgnRkFJTEVEIHJlc3BvbnNlIHNldHMgUGh5c2ljYWxSZXNvdXJjZUlkIHRvIGEgc3BlY2lhbCBtYXJrZXInLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+IHsgdGhyb3cgbmV3IEVycm9yKCdDUkVBVEUgRkFJTEVEJyk7IH07XG5cbiAgICAvLyBUSEVOXG4gICAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZSdcbiAgICB9KTtcblxuICAgIGV4cGVjdENsb3VkRm9ybWF0aW9uRmFpbGVkKCdDUkVBVEUgRkFJTEVEJywge1xuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBjZm5SZXNwb25zZS5DUkVBVEVfRkFJTEVEX1BIWVNJQ0FMX0lEX01BUktFUixcbiAgICB9KTtcbiAgfSk7XG5cbiAgaXQoJ0RFTEVURSByZXF1ZXN0IHdpdGggdGhlIG1hcmtlciBzdWNjZWVkcyB3aXRob3V0IGNhbGxpbmcgdXNlciBoYW5kbGVyJywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgLy8gdXNlciBoYW5kbGVyIGlzIG5vdCBhc3NpZ25lZFxuXG4gICAgLy8gV0hFTlxuICAgIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgICAgUmVxdWVzdFR5cGU6ICdEZWxldGUnLFxuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBjZm5SZXNwb25zZS5DUkVBVEVfRkFJTEVEX1BIWVNJQ0FMX0lEX01BUktFUlxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdENsb3VkRm9ybWF0aW9uU3VjY2VzcygpO1xuICB9KTtcblxufSk7XG5cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbi8qKlxuICogVHJpZ2dlcnMgdGhlIGN1c3RvbSByZXNvdXJjZSBsaWZlY3ljbGUgZXZlbnQgZmxvdyBieSBpbnZva2luZyB0aGUgZnJhbWV3b3JrJ3NcbiAqIG9uRXZlbnQgZnVuY3Rpb24gYW5kIHRoZW4sIGlmIHRoZSB3YWl0ZXIgc3RhdGUgbWFjaGluZSB3YXMgc3RhcnRlZCwgc2ltdWxhdGVzXG4gKiB0aGUgd2FpdGVyIGFuZCBpbnZva2VzIGlzQ29tcGxldGUgYW5kIG9uVGltZW91dCBhcyBhcHByb3ByaWF0ZS5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gc2ltdWxhdGVFdmVudChyZXE6IFBhcnRpYWw8QVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudD4pIHtcbiAgY29uc3QgeCA9IHtcbiAgICBTZXJ2aWNlVG9rZW46ICdTRVJWSUNFLVRPS0VOJyxcbiAgICBSZXNwb25zZVVSTDogbW9ja3MuTU9DS19SRVFVRVNULlJlc3BvbnNlVVJMLFxuICAgIFN0YWNrSWQ6IG1vY2tzLk1PQ0tfUkVRVUVTVC5TdGFja0lkLFxuICAgIFJlcXVlc3RJZDogbW9ja3MuTU9DS19SRVFVRVNULlJlcXVlc3RJZCxcbiAgICBSZXNvdXJjZVR5cGU6ICdDdXN0b206OlRlc3RSZXNvdXJjZScsXG4gICAgTG9naWNhbFJlc291cmNlSWQ6IG1vY2tzLk1PQ0tfUkVRVUVTVC5Mb2dpY2FsUmVzb3VyY2VJZCxcbiAgICAuLi5yZXFcbiAgfTtcblxuICBtb2Nrcy5wcmVwYXJlRm9yRXhlY3V0aW9uKCk7XG5cbiAgYXdhaXQgZnJhbWV3b3JrLm9uRXZlbnQoeCBhcyBBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50KTtcblxuICAvLyBpZiB0aGUgRlNNXG4gIGlmIChtb2Nrcy5zdGFydFN0YXRlTWFjaGluZUlucHV0ICYmIG1vY2tzLnN0YXJ0U3RhdGVNYWNoaW5lSW5wdXQuc3RhdGVNYWNoaW5lQXJuID09PSBtb2Nrcy5NT0NLX1NGTl9BUk4pIHtcbiAgICBhd2FpdCBzaW11bGF0ZVdhaXRlcihKU09OLnBhcnNlKG1vY2tzLnN0YXJ0U3RhdGVNYWNoaW5lSW5wdXQuaW5wdXQhKSk7XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBzaW11bGF0ZVdhaXRlcihldmVudDogQVdTQ0RLQXN5bmNDdXN0b21SZXNvdXJjZS5Jc0NvbXBsZXRlUmVxdWVzdCkge1xuICAgIGxldCByZXRyeSA9IHRydWU7XG4gICAgbGV0IGNvdW50ID0gNTtcbiAgICB3aGlsZSAocmV0cnkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZyYW1ld29yay5pc0NvbXBsZXRlKGV2ZW50KTtcbiAgICAgICAgcmV0cnkgPSBmYWxzZTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBjZm5SZXNwb25zZS5SZXRyeSkge1xuICAgICAgICAgIGlmIChjb3VudC0tID09PSAwKSB7XG4gICAgICAgICAgICBhd2FpdCBmcmFtZXdvcmsub25UaW1lb3V0KHsgQ2F1c2U6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3JNZXNzYWdlOiBlLm1lc3NhZ2UgfSkgfSk7XG4gICAgICAgICAgICByZXRyeSA9IGZhbHNlO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXRyeSA9IHRydWU7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGV4cGVjdENsb3VkRm9ybWF0aW9uRmFpbGVkKGV4cGVjdGVkUmVhc29uOiBzdHJpbmcsIHJlc3A/OiBQYXJ0aWFsPEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlUmVzcG9uc2U+KSB7XG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uUmVzcG9uc2Uoe1xuICAgIFN0YXR1czogJ0ZBSUxFRCcsXG4gICAgUmVhc29uOiBleHBlY3RlZFJlYXNvbixcbiAgICAuLi5yZXNwXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBleHBlY3RDbG91ZEZvcm1hdGlvblN1Y2Nlc3MocmVzcD86IFBhcnRpYWw8QVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VSZXNwb25zZT4pIHtcbiAgaWYgKG1vY2tzLmNmblJlc3BvbnNlLlN0YXR1cyAhPT0gJ1NVQ0NFU1MnKSB7XG4gICAgY29uc29sZS5lcnJvcihtb2Nrcy5jZm5SZXNwb25zZS5SZWFzb24gfHwgJzxOTyBSRUFTT04+Jyk7XG4gIH1cblxuICBleHBlY3RDbG91ZEZvcm1hdGlvblJlc3BvbnNlKHsgU3RhdHVzOiAnU1VDQ0VTUycsIC4uLnJlc3AgfSk7XG59XG5cbmZ1bmN0aW9uIGV4cGVjdENsb3VkRm9ybWF0aW9uUmVzcG9uc2UocmVzcDogUGFydGlhbDxBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVJlc3BvbnNlPiA9IHt9KSB7XG4gIGZvciAoY29uc3QgW2tleSwgZXhwZWN0ZWRdIG9mIE9iamVjdC5lbnRyaWVzKHJlc3ApKSB7XG4gICAgY29uc3QgYWN0dWFsID0gKG1vY2tzLmNmblJlc3BvbnNlIGFzIGFueSlba2V5XTtcbiAgICBleHBlY3QoYWN0dWFsKS50b1N0cmljdEVxdWFsKGV4cGVjdGVkIGFzIGFueSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZXhwZWN0Tm9XYWl0ZXIoKSB7XG4gIGV4cGVjdChtb2Nrcy5zdGFydFN0YXRlTWFjaGluZUlucHV0KS50b0JlVW5kZWZpbmVkKCk7XG59XG4iXX0=