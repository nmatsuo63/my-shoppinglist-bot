"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk_assets_schema_1 = require("@aws-cdk/cdk-assets-schema");
const mockfs = require("mock-fs");
const lib_1 = require("../lib");
beforeEach(() => {
    mockfs({
        '/simple/cdk.out/assets.json': JSON.stringify({
            version: cdk_assets_schema_1.AssetManifestSchema.currentVersion(),
            files: {
                asset1: {
                    type: 'file',
                    source: { path: 'S1' },
                    destinations: {
                        dest1: { bucketName: 'D1', objectKey: 'X' },
                        dest2: { bucketName: 'D2', objectKey: 'X' },
                    },
                },
            },
            dockerImages: {
                asset2: {
                    type: 'thing',
                    source: { directory: 'S2' },
                    destinations: {
                        dest1: { repositoryName: 'D3', imageTag: 'X' },
                        dest2: { repositoryName: 'D4', imageTag: 'X' },
                    },
                },
            },
        })
    });
});
afterEach(() => {
    mockfs.restore();
});
test('Can list manifest', () => {
    const manifest = lib_1.AssetManifest.fromPath('/simple/cdk.out');
    expect(manifest.list().join('\n')).toEqual(`
asset1 file {\"path\":\"S1\"}
  ├ asset1:dest1 {\"bucketName\":\"D1\",\"objectKey\":\"X\"}
  └ asset1:dest2 {\"bucketName\":\"D2\",\"objectKey\":\"X\"}
asset2 docker-image {\"directory\":\"S2\"}
  ├ asset2:dest1 {\"repositoryName\":\"D3\",\"imageTag\":\"X\"}
  └ asset2:dest2 {\"repositoryName\":\"D4\",\"imageTag\":\"X\"}
`.trim());
});
test('.entries() iterates over all destinations', () => {
    const manifest = lib_1.AssetManifest.fromPath('/simple/cdk.out');
    expect(manifest.entries).toEqual([
        new lib_1.FileManifestEntry(new lib_1.DestinationIdentifier('asset1', 'dest1'), { path: 'S1' }, { bucketName: 'D1', objectKey: 'X' }),
        new lib_1.FileManifestEntry(new lib_1.DestinationIdentifier('asset1', 'dest2'), { path: 'S1' }, { bucketName: 'D2', objectKey: 'X' }),
        new lib_1.DockerImageManifestEntry(new lib_1.DestinationIdentifier('asset2', 'dest1'), { directory: 'S2' }, { repositoryName: 'D3', imageTag: 'X' }),
        new lib_1.DockerImageManifestEntry(new lib_1.DestinationIdentifier('asset2', 'dest2'), { directory: 'S2' }, { repositoryName: 'D4', imageTag: 'X' }),
    ]);
});
test('can select by asset ID', () => {
    const manifest = lib_1.AssetManifest.fromPath('/simple/cdk.out');
    const subset = manifest.select([lib_1.DestinationPattern.parse('asset2')]);
    expect(subset.entries.map(e => f(e.genericDestination, 'repositoryName'))).toEqual(['D3', 'D4']);
});
test('can select by asset ID + destination ID', () => {
    const manifest = lib_1.AssetManifest.fromPath('/simple/cdk.out');
    const subset = manifest.select([
        lib_1.DestinationPattern.parse('asset1:dest1'),
        lib_1.DestinationPattern.parse('asset2:dest2'),
    ]);
    expect(subset.entries.map(e => f(e.genericDestination, 'repositoryName', 'bucketName'))).toEqual(['D1', 'D4']);
});
test('can select by destination ID', () => {
    const manifest = lib_1.AssetManifest.fromPath('/simple/cdk.out');
    const subset = manifest.select([
        lib_1.DestinationPattern.parse(':dest1'),
    ]);
    expect(subset.entries.map(e => f(e.genericDestination, 'repositoryName', 'bucketName'))).toEqual(['D1', 'D3']);
});
test('empty string is not a valid pattern', () => {
    expect(() => {
        lib_1.DestinationPattern.parse('');
    }).toThrow(/Empty string is not a valid destination identifier/);
});
test('pattern must have two components', () => {
    expect(() => {
        lib_1.DestinationPattern.parse('a:b:c');
    }).toThrow(/Asset identifier must contain at most 2/);
});
test('parse ASSET:* the same as ASSET and ASSET:', () => {
    expect(lib_1.DestinationPattern.parse('a:*')).toEqual(lib_1.DestinationPattern.parse('a'));
    expect(lib_1.DestinationPattern.parse('a:*')).toEqual(lib_1.DestinationPattern.parse('a:'));
});
test('parse *:DEST the same as :DEST', () => {
    expect(lib_1.DestinationPattern.parse('*:a')).toEqual(lib_1.DestinationPattern.parse(':a'));
});
function f(obj, ...keys) {
    for (const k of keys) {
        if (typeof obj === 'object' && obj !== null && k in obj) {
            return obj[k];
        }
    }
    return undefined;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuaWZlc3QudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1hbmlmZXN0LnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxrRUFBaUU7QUFDakUsa0NBQWtDO0FBQ2xDLGdDQUErSDtBQUUvSCxVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsTUFBTSxDQUFDO1FBQ0wsNkJBQTZCLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUM1QyxPQUFPLEVBQUUsdUNBQW1CLENBQUMsY0FBYyxFQUFFO1lBQzdDLEtBQUssRUFBRTtnQkFDTCxNQUFNLEVBQUU7b0JBQ04sSUFBSSxFQUFFLE1BQU07b0JBQ1osTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRTtvQkFDdEIsWUFBWSxFQUFFO3dCQUNaLEtBQUssRUFBRSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRTt3QkFDM0MsS0FBSyxFQUFFLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFO3FCQUM1QztpQkFDRjthQUNGO1lBQ0QsWUFBWSxFQUFFO2dCQUNaLE1BQU0sRUFBRTtvQkFDTixJQUFJLEVBQUUsT0FBTztvQkFDYixNQUFNLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFO29CQUMzQixZQUFZLEVBQUU7d0JBQ1osS0FBSyxFQUFFLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFO3dCQUM5QyxLQUFLLEVBQUUsRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUU7cUJBQy9DO2lCQUNGO2FBQ0Y7U0FDRixDQUFDO0tBQ0gsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxTQUFTLENBQUMsR0FBRyxFQUFFO0lBQ2IsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ25CLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxD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QWtCLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLHdCQUFrQixDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ2xGLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLGdDQUFnQyxFQUFFLEdBQUcsRUFBRTtJQUMxQyxNQUFNLENBQUMsd0JBQWtCLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLHdCQUFrQixDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ2xGLENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyxDQUFDLENBQUMsR0FBWSxFQUFFLEdBQUcsSUFBYztJQUN4QyxLQUFLLE1BQU0sQ0FBQyxJQUFJLElBQUksRUFBRTtRQUNwQixJQUFJLE9BQU8sR0FBRyxLQUFLLFFBQVEsSUFBSSxHQUFHLEtBQUssSUFBSSxJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUU7WUFDdkQsT0FBUSxHQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDeEI7S0FDRjtJQUNELE9BQU8sU0FBUyxDQUFDO0FBQ25CLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBc3NldE1hbmlmZXN0U2NoZW1hIH0gZnJvbSAnQGF3cy1jZGsvY2RrLWFzc2V0cy1zY2hlbWEnO1xuaW1wb3J0ICogYXMgbW9ja2ZzIGZyb20gJ21vY2stZnMnO1xuaW1wb3J0IHsgQXNzZXRNYW5pZmVzdCwgRGVzdGluYXRpb25JZGVudGlmaWVyLCBEZXN0aW5hdGlvblBhdHRlcm4sIERvY2tlckltYWdlTWFuaWZlc3RFbnRyeSwgRmlsZU1hbmlmZXN0RW50cnkgfSBmcm9tICcuLi9saWInO1xuXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgbW9ja2ZzKHtcbiAgICAnL3NpbXBsZS9jZGsub3V0L2Fzc2V0cy5qc29uJzogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgdmVyc2lvbjogQXNzZXRNYW5pZmVzdFNjaGVtYS5jdXJyZW50VmVyc2lvbigpLFxuICAgICAgZmlsZXM6IHtcbiAgICAgICAgYXNzZXQxOiB7XG4gICAgICAgICAgdHlwZTogJ2ZpbGUnLFxuICAgICAgICAgIHNvdXJjZTogeyBwYXRoOiAnUzEnIH0sXG4gICAgICAgICAgZGVzdGluYXRpb25zOiB7XG4gICAgICAgICAgICBkZXN0MTogeyBidWNrZXROYW1lOiAnRDEnLCBvYmplY3RLZXk6ICdYJyB9LFxuICAgICAgICAgICAgZGVzdDI6IHsgYnVja2V0TmFtZTogJ0QyJywgb2JqZWN0S2V5OiAnWCcgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIGRvY2tlckltYWdlczoge1xuICAgICAgICBhc3NldDI6IHtcbiAgICAgICAgICB0eXBlOiAndGhpbmcnLFxuICAgICAgICAgIHNvdXJjZTogeyBkaXJlY3Rvcnk6ICdTMicgfSxcbiAgICAgICAgICBkZXN0aW5hdGlvbnM6IHtcbiAgICAgICAgICAgIGRlc3QxOiB7IHJlcG9zaXRvcnlOYW1lOiAnRDMnLCBpbWFnZVRhZzogJ1gnIH0sXG4gICAgICAgICAgICBkZXN0MjogeyByZXBvc2l0b3J5TmFtZTogJ0Q0JywgaW1hZ2VUYWc6ICdYJyB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pXG4gIH0pO1xufSk7XG5cbmFmdGVyRWFjaCgoKSA9PiB7XG4gIG1vY2tmcy5yZXN0b3JlKCk7XG59KTtcblxudGVzdCgnQ2FuIGxpc3QgbWFuaWZlc3QnLCAoKSA9PiB7XG4gIGNvbnN0IG1hbmlmZXN0ID0gQXNzZXRNYW5pZmVzdC5mcm9tUGF0aCgnL3NpbXBsZS9jZGsub3V0Jyk7XG4gIGV4cGVjdChtYW5pZmVzdC5saXN0KCkuam9pbignXFxuJykpLnRvRXF1YWwoYFxuYXNzZXQxIGZpbGUge1xcXCJwYXRoXFxcIjpcXFwiUzFcXFwifVxuICDilJwgYXNzZXQxOmRlc3QxIHtcXFwiYnVja2V0TmFtZVxcXCI6XFxcIkQxXFxcIixcXFwib2JqZWN0S2V5XFxcIjpcXFwiWFxcXCJ9XG4gIOKUlCBhc3NldDE6ZGVzdDIge1xcXCJidWNrZXROYW1lXFxcIjpcXFwiRDJcXFwiLFxcXCJvYmplY3RLZXlcXFwiOlxcXCJYXFxcIn1cbmFzc2V0MiBkb2NrZXItaW1hZ2Uge1xcXCJkaXJlY3RvcnlcXFwiOlxcXCJTMlxcXCJ9XG4gIOKUnCBhc3NldDI6ZGVzdDEge1xcXCJyZXBvc2l0b3J5TmFtZVxcXCI6XFxcIkQzXFxcIixcXFwiaW1hZ2VUYWdcXFwiOlxcXCJYXFxcIn1cbiAg4pSUIGFzc2V0MjpkZXN0MiB7XFxcInJlcG9zaXRvcnlOYW1lXFxcIjpcXFwiRDRcXFwiLFxcXCJpbWFnZVRhZ1xcXCI6XFxcIlhcXFwifVxuYC50cmltKCkpO1xufSk7XG5cbnRlc3QoJy5lbnRyaWVzKCkgaXRlcmF0ZXMgb3ZlciBhbGwgZGVzdGluYXRpb25zJywgKCkgPT4ge1xuICBjb25zdCBtYW5pZmVzdCA9IEFzc2V0TWFuaWZlc3QuZnJvbVBhdGgoJy9zaW1wbGUvY2RrLm91dCcpO1xuXG4gIGV4cGVjdChtYW5pZmVzdC5lbnRyaWVzKS50b0VxdWFsKFtcbiAgICBuZXcgRmlsZU1hbmlmZXN0RW50cnkobmV3IERlc3RpbmF0aW9uSWRlbnRpZmllcignYXNzZXQxJywgJ2Rlc3QxJyksIHsgcGF0aDogJ1MxJyB9LCB7IGJ1Y2tldE5hbWU6ICdEMScsIG9iamVjdEtleTogJ1gnIH0pLFxuICAgIG5ldyBGaWxlTWFuaWZlc3RFbnRyeShuZXcgRGVzdGluYXRpb25JZGVudGlmaWVyKCdhc3NldDEnLCAnZGVzdDInKSwgeyBwYXRoOiAnUzEnIH0sIHsgYnVja2V0TmFtZTogJ0QyJywgb2JqZWN0S2V5OiAnWCcgfSksXG4gICAgbmV3IERvY2tlckltYWdlTWFuaWZlc3RFbnRyeShuZXcgRGVzdGluYXRpb25JZGVudGlmaWVyKCdhc3NldDInLCAnZGVzdDEnKSwgeyBkaXJlY3Rvcnk6ICdTMicgfSwgeyByZXBvc2l0b3J5TmFtZTogJ0QzJywgaW1hZ2VUYWc6ICdYJyB9KSxcbiAgICBuZXcgRG9ja2VySW1hZ2VNYW5pZmVzdEVudHJ5KG5ldyBEZXN0aW5hdGlvbklkZW50aWZpZXIoJ2Fzc2V0MicsICdkZXN0MicpLCB7IGRpcmVjdG9yeTogJ1MyJyB9LCB7IHJlcG9zaXRvcnlOYW1lOiAnRDQnLCBpbWFnZVRhZzogJ1gnIH0pLFxuICBdKTtcbn0pO1xuXG50ZXN0KCdjYW4gc2VsZWN0IGJ5IGFzc2V0IElEJywgKCkgPT4ge1xuICBjb25zdCBtYW5pZmVzdCA9IEFzc2V0TWFuaWZlc3QuZnJvbVBhdGgoJy9zaW1wbGUvY2RrLm91dCcpO1xuXG4gIGNvbnN0IHN1YnNldCA9IG1hbmlmZXN0LnNlbGVjdChbRGVzdGluYXRpb25QYXR0ZXJuLnBhcnNlKCdhc3NldDInKV0pO1xuXG4gIGV4cGVjdChzdWJzZXQuZW50cmllcy5tYXAoZSA9PiBmKGUuZ2VuZXJpY0Rlc3RpbmF0aW9uLCAncmVwb3NpdG9yeU5hbWUnKSkpLnRvRXF1YWwoWydEMycsICdENCddKTtcbn0pO1xuXG50ZXN0KCdjYW4gc2VsZWN0IGJ5IGFzc2V0IElEICsgZGVzdGluYXRpb24gSUQnLCAoKSA9PiB7XG4gIGNvbnN0IG1hbmlmZXN0ID0gQXNzZXRNYW5pZmVzdC5mcm9tUGF0aCgnL3NpbXBsZS9jZGsub3V0Jyk7XG5cbiAgY29uc3Qgc3Vic2V0ID0gbWFuaWZlc3Quc2VsZWN0KFtcbiAgICBEZXN0aW5hdGlvblBhdHRlcm4ucGFyc2UoJ2Fzc2V0MTpkZXN0MScpLFxuICAgIERlc3RpbmF0aW9uUGF0dGVybi5wYXJzZSgnYXNzZXQyOmRlc3QyJyksXG4gIF0pO1xuXG4gIGV4cGVjdChzdWJzZXQuZW50cmllcy5tYXAoZSA9PiBmKGUuZ2VuZXJpY0Rlc3RpbmF0aW9uLCAncmVwb3NpdG9yeU5hbWUnLCAnYnVja2V0TmFtZScpKSkudG9FcXVhbChbJ0QxJywgJ0Q0J10pO1xufSk7XG5cbnRlc3QoJ2NhbiBzZWxlY3QgYnkgZGVzdGluYXRpb24gSUQnLCAoKSA9PiB7XG4gIGNvbnN0IG1hbmlmZXN0ID0gQXNzZXRNYW5pZmVzdC5mcm9tUGF0aCgnL3NpbXBsZS9jZGsub3V0Jyk7XG5cbiAgY29uc3Qgc3Vic2V0ID0gbWFuaWZlc3Quc2VsZWN0KFtcbiAgICBEZXN0aW5hdGlvblBhdHRlcm4ucGFyc2UoJzpkZXN0MScpLFxuICBdKTtcblxuICBleHBlY3Qoc3Vic2V0LmVudHJpZXMubWFwKGUgPT4gZihlLmdlbmVyaWNEZXN0aW5hdGlvbiwgJ3JlcG9zaXRvcnlOYW1lJywgJ2J1Y2tldE5hbWUnKSkpLnRvRXF1YWwoWydEMScsICdEMyddKTtcbn0pO1xuXG50ZXN0KCdlbXB0eSBzdHJpbmcgaXMgbm90IGEgdmFsaWQgcGF0dGVybicsICgpID0+IHtcbiAgZXhwZWN0KCgpID0+IHtcbiAgICBEZXN0aW5hdGlvblBhdHRlcm4ucGFyc2UoJycpO1xuICB9KS50b1Rocm93KC9FbXB0eSBzdHJpbmcgaXMgbm90IGEgdmFsaWQgZGVzdGluYXRpb24gaWRlbnRpZmllci8pO1xufSk7XG5cbnRlc3QoJ3BhdHRlcm4gbXVzdCBoYXZlIHR3byBjb21wb25lbnRzJywgKCkgPT4ge1xuICBleHBlY3QoKCkgPT4ge1xuICAgIERlc3RpbmF0aW9uUGF0dGVybi5wYXJzZSgnYTpiOmMnKTtcbiAgfSkudG9UaHJvdygvQXNzZXQgaWRlbnRpZmllciBtdXN0IGNvbnRhaW4gYXQgbW9zdCAyLyk7XG59KTtcblxudGVzdCgncGFyc2UgQVNTRVQ6KiB0aGUgc2FtZSBhcyBBU1NFVCBhbmQgQVNTRVQ6JywgKCkgPT4ge1xuICBleHBlY3QoRGVzdGluYXRpb25QYXR0ZXJuLnBhcnNlKCdhOionKSkudG9FcXVhbChEZXN0aW5hdGlvblBhdHRlcm4ucGFyc2UoJ2EnKSk7XG4gIGV4cGVjdChEZXN0aW5hdGlvblBhdHRlcm4ucGFyc2UoJ2E6KicpKS50b0VxdWFsKERlc3RpbmF0aW9uUGF0dGVybi5wYXJzZSgnYTonKSk7XG59KTtcblxudGVzdCgncGFyc2UgKjpERVNUIHRoZSBzYW1lIGFzIDpERVNUJywgKCkgPT4ge1xuICBleHBlY3QoRGVzdGluYXRpb25QYXR0ZXJuLnBhcnNlKCcqOmEnKSkudG9FcXVhbChEZXN0aW5hdGlvblBhdHRlcm4ucGFyc2UoJzphJykpO1xufSk7XG5cbmZ1bmN0aW9uIGYob2JqOiB1bmtub3duLCAuLi5rZXlzOiBzdHJpbmdbXSk6IGFueSB7XG4gIGZvciAoY29uc3QgayBvZiBrZXlzKSB7XG4gICAgaWYgKHR5cGVvZiBvYmogPT09ICdvYmplY3QnICYmIG9iaiAhPT0gbnVsbCAmJiBrIGluIG9iaikge1xuICAgICAgcmV0dXJuIChvYmogYXMgYW55KVtrXTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cbiJdfQ==