"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk_assets_schema_1 = require("@aws-cdk/cdk-assets-schema");
const mockfs = require("mock-fs");
const lib_1 = require("../lib");
const mock_aws_1 = require("./mock-aws");
let aws;
beforeEach(() => {
    mockfs({
        '/simple/cdk.out/assets.json': JSON.stringify({
            version: cdk_assets_schema_1.AssetManifestSchema.currentVersion(),
            files: {
                theAsset: {
                    source: {
                        path: 'some_file'
                    },
                    destinations: {
                        theDestination: {
                            region: 'us-north-50',
                            assumeRoleArn: 'arn:aws:role',
                            bucketName: 'some_bucket',
                            objectKey: 'some_key',
                        },
                    },
                },
            },
        }),
        '/simple/cdk.out/some_file': 'FILE_CONTENTS',
        '/abs/cdk.out/assets.json': JSON.stringify({
            version: cdk_assets_schema_1.AssetManifestSchema.currentVersion(),
            files: {
                theAsset: {
                    source: {
                        path: '/simple/cdk.out/some_file'
                    },
                    destinations: {
                        theDestination: {
                            region: 'us-north-50',
                            assumeRoleArn: 'arn:aws:role',
                            bucketName: 'some_bucket',
                            objectKey: 'some_key',
                        },
                    },
                },
            },
        }),
    });
    aws = mock_aws_1.mockAws();
});
afterEach(() => {
    mockfs.restore();
});
test('pass destination properties to AWS client', async () => {
    const pub = new lib_1.AssetPublishing(lib_1.AssetManifest.fromPath('/simple/cdk.out'), { aws, throwOnError: false });
    await pub.publish();
    expect(aws.s3Client).toHaveBeenCalledWith(expect.objectContaining({
        region: 'us-north-50',
        assumeRoleArn: 'arn:aws:role',
    }));
});
test('Do nothing if file already exists', async () => {
    const pub = new lib_1.AssetPublishing(lib_1.AssetManifest.fromPath('/simple/cdk.out'), { aws, });
    aws.mockS3.headObject = mock_aws_1.mockedApiResult({ /* No error == file exists */});
    await pub.publish();
    expect(aws.mockS3.headObject).toHaveBeenCalledWith(expect.objectContaining({
        Bucket: 'some_bucket',
        Key: 'some_key'
    }));
});
test('upload file if new', async () => {
    const pub = new lib_1.AssetPublishing(lib_1.AssetManifest.fromPath('/simple/cdk.out'), { aws });
    aws.mockS3.headObject = mock_aws_1.mockedApiFailure('NotFound', 'File does not exist');
    aws.mockS3.upload = mock_aws_1.mockUpload('FILE_CONTENTS');
    await pub.publish();
    expect(aws.mockS3.upload).toHaveBeenCalledWith(expect.objectContaining({
        Bucket: 'some_bucket',
        Key: 'some_key'
    }));
    // We'll just have to assume the contents are correct
});
test('successful run does not need to query account ID', async () => {
    const pub = new lib_1.AssetPublishing(lib_1.AssetManifest.fromPath('/simple/cdk.out'), { aws });
    aws.mockS3.headObject = mock_aws_1.mockedApiFailure('NotFound', 'File does not exist');
    aws.mockS3.upload = mock_aws_1.mockUpload('FILE_CONTENTS');
    await pub.publish();
    expect(aws.discoverCurrentAccount).not.toHaveBeenCalled();
});
test('correctly identify asset path if path is absolute', async () => {
    const pub = new lib_1.AssetPublishing(lib_1.AssetManifest.fromPath('/abs/cdk.out'), { aws });
    aws.mockS3.headObject = mock_aws_1.mockedApiFailure('NotFound', 'File does not exist');
    aws.mockS3.upload = mock_aws_1.mockUpload('FILE_CONTENTS');
    await pub.publish();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZXMudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImZpbGVzLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxrRUFBaUU7QUFDakUsa0NBQWtDO0FBQ2xDLGdDQUF3RDtBQUN4RCx5Q0FBb0Y7QUFFcEYsSUFBSSxHQUErQixDQUFDO0FBQ3BDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxNQUFNLENBQUM7UUFDTCw2QkFBNkIsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQzVDLE9BQU8sRUFBRSx1Q0FBbUIsQ0FBQyxjQUFjLEVBQUU7WUFDN0MsS0FBSyxFQUFFO2dCQUNMLFFBQVEsRUFBRTtvQkFDUixNQUFNLEVBQUU7d0JBQ04sSUFBSSxFQUFFLFdBQVc7cUJBQ2xCO29CQUNELFlBQVksRUFBRTt3QkFDWixjQUFjLEVBQUU7NEJBQ2QsTUFBTSxFQUFFLGFBQWE7NEJBQ3JCLGFBQWEsRUFBRSxjQUFjOzRCQUM3QixVQUFVLEVBQUUsYUFBYTs0QkFDekIsU0FBUyxFQUFFLFVBQVU7eUJBQ3RCO3FCQUNGO2lCQUNGO2FBQ0Y7U0FDRixDQUFDO1FBQ0YsMkJBQTJCLEVBQUUsZUFBZTtRQUM1QywwQkFBMEIsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ3pDLE9BQU8sRUFBRSx1Q0FBbUIsQ0FBQyxjQUFjLEVBQUU7WUFDN0MsS0FBSyxFQUFFO2dCQUNMLFFBQVEsRUFBRTtvQkFDUixNQUFNLEVBQUU7d0JBQ04sSUFBSSxFQUFFLDJCQUEyQjtxQkFDbEM7b0JBQ0QsWUFBWSxFQUFFO3dCQUNaLGNBQWMsRUFBRTs0QkFDZCxNQUFNLEVBQUUsYUFBYTs0QkFDckIsYUFBYSxFQUFFLGNBQWM7NEJBQzdCLFVBQVUsRUFBRSxhQUFhOzRCQUN6QixTQUFTLEVBQUUsVUFBVTt5QkFDdEI7cUJBQ0Y7aUJBQ0Y7YUFDRjtTQUNGLENBQUM7S0FDSCxDQUFDLENBQUM7SUFFSCxHQUFHLEdBQUcsa0JBQU8sRUFBRSxDQUFDO0FB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S0FBSyxJQUFJLEVBQUU7SUFDbkUsTUFBTSxHQUFHLEdBQUcsSUFBSSxxQkFBZSxDQUFDLG1CQUFhLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUVqRixHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsR0FBRywyQkFBZ0IsQ0FBQyxVQUFVLEVBQUUscUJBQXFCLENBQUMsQ0FBQztJQUM1RSxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxxQkFBVSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBRWhELE1BQU0sR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ3RCLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXNzZXRNYW5pZmVzdFNjaGVtYSB9IGZyb20gJ0Bhd3MtY2RrL2Nkay1hc3NldHMtc2NoZW1hJztcbmltcG9ydCAqIGFzIG1vY2tmcyBmcm9tICdtb2NrLWZzJztcbmltcG9ydCB7IEFzc2V0TWFuaWZlc3QsIEFzc2V0UHVibGlzaGluZyB9IGZyb20gJy4uL2xpYic7XG5pbXBvcnQgeyBtb2NrQXdzLCBtb2NrZWRBcGlGYWlsdXJlLCBtb2NrZWRBcGlSZXN1bHQsIG1vY2tVcGxvYWQgfSBmcm9tICcuL21vY2stYXdzJztcblxubGV0IGF3czogUmV0dXJuVHlwZTx0eXBlb2YgbW9ja0F3cz47XG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgbW9ja2ZzKHtcbiAgICAnL3NpbXBsZS9jZGsub3V0L2Fzc2V0cy5qc29uJzogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgdmVyc2lvbjogQXNzZXRNYW5pZmVzdFNjaGVtYS5jdXJyZW50VmVyc2lvbigpLFxuICAgICAgZmlsZXM6IHtcbiAgICAgICAgdGhlQXNzZXQ6IHtcbiAgICAgICAgICBzb3VyY2U6IHtcbiAgICAgICAgICAgIHBhdGg6ICdzb21lX2ZpbGUnXG4gICAgICAgICAgfSxcbiAgICAgICAgICBkZXN0aW5hdGlvbnM6IHtcbiAgICAgICAgICAgIHRoZURlc3RpbmF0aW9uOiB7XG4gICAgICAgICAgICAgIHJlZ2lvbjogJ3VzLW5vcnRoLTUwJyxcbiAgICAgICAgICAgICAgYXNzdW1lUm9sZUFybjogJ2Fybjphd3M6cm9sZScsXG4gICAgICAgICAgICAgIGJ1Y2tldE5hbWU6ICdzb21lX2J1Y2tldCcsXG4gICAgICAgICAgICAgIG9iamVjdEtleTogJ3NvbWVfa2V5JyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSksXG4gICAgJy9zaW1wbGUvY2RrLm91dC9zb21lX2ZpbGUnOiAnRklMRV9DT05URU5UUycsXG4gICAgJy9hYnMvY2RrLm91dC9hc3NldHMuanNvbic6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIHZlcnNpb246IEFzc2V0TWFuaWZlc3RTY2hlbWEuY3VycmVudFZlcnNpb24oKSxcbiAgICAgIGZpbGVzOiB7XG4gICAgICAgIHRoZUFzc2V0OiB7XG4gICAgICAgICAgc291cmNlOiB7XG4gICAgICAgICAgICBwYXRoOiAnL3NpbXBsZS9jZGsub3V0L3NvbWVfZmlsZSdcbiAgICAgICAgICB9LFxuICAgICAgICAgIGRlc3RpbmF0aW9uczoge1xuICAgICAgICAgICAgdGhlRGVzdGluYXRpb246IHtcbiAgICAgICAgICAgICAgcmVnaW9uOiAndXMtbm9ydGgtNTAnLFxuICAgICAgICAgICAgICBhc3N1bWVSb2xlQXJuOiAnYXJuOmF3czpyb2xlJyxcbiAgICAgICAgICAgICAgYnVja2V0TmFtZTogJ3NvbWVfYnVja2V0JyxcbiAgICAgICAgICAgICAgb2JqZWN0S2V5OiAnc29tZV9rZXknLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KSxcbiAgfSk7XG5cbiAgYXdzID0gbW9ja0F3cygpO1xufSk7XG5cbmFmdGVyRWFjaCgoKSA9PiB7XG4gIG1vY2tmcy5yZXN0b3JlKCk7XG59KTtcblxudGVzdCgncGFzcyBkZXN0aW5hdGlvbiBwcm9wZXJ0aWVzIHRvIEFXUyBjbGllbnQnLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IHB1YiA9IG5ldyBBc3NldFB1Ymxpc2hpbmcoQXNzZXRNYW5pZmVzdC5mcm9tUGF0aCgnL3NpbXBsZS9jZGsub3V0JyksIHsgYXdzLCB0aHJvd09uRXJyb3I6IGZhbHNlIH0pO1xuXG4gIGF3YWl0IHB1Yi5wdWJsaXNoKCk7XG5cbiAgZXhwZWN0KGF3cy5zM0NsaWVudCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgIHJlZ2lvbjogJ3VzLW5vcnRoLTUwJyxcbiAgICBhc3N1bWVSb2xlQXJuOiAnYXJuOmF3czpyb2xlJyxcbiAgfSkpO1xufSk7XG5cbnRlc3QoJ0RvIG5vdGhpbmcgaWYgZmlsZSBhbHJlYWR5IGV4aXN0cycsIGFzeW5jICgpID0+IHtcbiAgY29uc3QgcHViID0gbmV3IEFzc2V0UHVibGlzaGluZyhBc3NldE1hbmlmZXN0LmZyb21QYXRoKCcvc2ltcGxlL2Nkay5vdXQnKSAsIHsgYXdzLCB9KTtcblxuICBhd3MubW9ja1MzLmhlYWRPYmplY3QgPSBtb2NrZWRBcGlSZXN1bHQoeyAvKiBObyBlcnJvciA9PSBmaWxlIGV4aXN0cyAqLyB9KTtcblxuICBhd2FpdCBwdWIucHVibGlzaCgpO1xuXG4gIGV4cGVjdChhd3MubW9ja1MzLmhlYWRPYmplY3QpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICBCdWNrZXQ6ICdzb21lX2J1Y2tldCcsXG4gICAgS2V5OiAnc29tZV9rZXknXG4gIH0pKTtcbn0pO1xuXG50ZXN0KCd1cGxvYWQgZmlsZSBpZiBuZXcnLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IHB1YiA9IG5ldyBBc3NldFB1Ymxpc2hpbmcoQXNzZXRNYW5pZmVzdC5mcm9tUGF0aCgnL3NpbXBsZS9jZGsub3V0JyksIHsgYXdzIH0pO1xuXG4gIGF3cy5tb2NrUzMuaGVhZE9iamVjdCA9IG1vY2tlZEFwaUZhaWx1cmUoJ05vdEZvdW5kJywgJ0ZpbGUgZG9lcyBub3QgZXhpc3QnKTtcbiAgYXdzLm1vY2tTMy51cGxvYWQgPSBtb2NrVXBsb2FkKCdGSUxFX0NPTlRFTlRTJyk7XG5cbiAgYXdhaXQgcHViLnB1Ymxpc2goKTtcblxuICBleHBlY3QoYXdzLm1vY2tTMy51cGxvYWQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICBCdWNrZXQ6ICdzb21lX2J1Y2tldCcsXG4gICAgS2V5OiAnc29tZV9rZXknXG4gIH0pKTtcblxuICAvLyBXZSdsbCBqdXN0IGhhdmUgdG8gYXNzdW1lIHRoZSBjb250ZW50cyBhcmUgY29ycmVjdFxufSk7XG5cbnRlc3QoJ3N1Y2Nlc3NmdWwgcnVuIGRvZXMgbm90IG5lZWQgdG8gcXVlcnkgYWNjb3VudCBJRCcsIGFzeW5jICgpID0+IHtcbiAgY29uc3QgcHViID0gbmV3IEFzc2V0UHVibGlzaGluZyhBc3NldE1hbmlmZXN0LmZyb21QYXRoKCcvc2ltcGxlL2Nkay5vdXQnKSwgeyBhd3MgfSk7XG5cbiAgYXdzLm1vY2tTMy5oZWFkT2JqZWN0ID0gbW9ja2VkQXBpRmFpbHVyZSgnTm90Rm91bmQnLCAnRmlsZSBkb2VzIG5vdCBleGlzdCcpO1xuICBhd3MubW9ja1MzLnVwbG9hZCA9IG1vY2tVcGxvYWQoJ0ZJTEVfQ09OVEVOVFMnKTtcblxuICBhd2FpdCBwdWIucHVibGlzaCgpO1xuXG4gIGV4cGVjdChhd3MuZGlzY292ZXJDdXJyZW50QWNjb3VudCkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbn0pO1xuXG50ZXN0KCdjb3JyZWN0bHkgaWRlbnRpZnkgYXNzZXQgcGF0aCBpZiBwYXRoIGlzIGFic29sdXRlJywgYXN5bmMgKCkgPT4ge1xuICBjb25zdCBwdWIgPSBuZXcgQXNzZXRQdWJsaXNoaW5nKEFzc2V0TWFuaWZlc3QuZnJvbVBhdGgoJy9hYnMvY2RrLm91dCcpLCB7IGF3cyB9KTtcblxuICBhd3MubW9ja1MzLmhlYWRPYmplY3QgPSBtb2NrZWRBcGlGYWlsdXJlKCdOb3RGb3VuZCcsICdGaWxlIGRvZXMgbm90IGV4aXN0Jyk7XG4gIGF3cy5tb2NrUzMudXBsb2FkID0gbW9ja1VwbG9hZCgnRklMRV9DT05URU5UUycpO1xuXG4gIGF3YWl0IHB1Yi5wdWJsaXNoKCk7XG59KTsiXX0=