"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('child_process');
const cdk_assets_schema_1 = require("@aws-cdk/cdk-assets-schema");
const mockfs = require("mock-fs");
const lib_1 = require("../lib");
const mock_aws_1 = require("./mock-aws");
const mock_child_process_1 = require("./mock-child_process");
let aws;
const absoluteDockerPath = '/simple/cdk.out/dockerdir';
beforeEach(() => {
    mockfs({
        '/simple/cdk.out/assets.json': JSON.stringify({
            version: cdk_assets_schema_1.AssetManifestSchema.currentVersion(),
            dockerImages: {
                theAsset: {
                    source: {
                        directory: 'dockerdir'
                    },
                    destinations: {
                        theDestination: {
                            region: 'us-north-50',
                            assumeRoleArn: 'arn:aws:role',
                            repositoryName: 'repo',
                            imageTag: 'abcdef',
                        },
                    },
                },
            },
        }),
        '/simple/cdk.out/dockerdir/Dockerfile': 'FROM scratch',
        '/abs/cdk.out/assets.json': JSON.stringify({
            version: cdk_assets_schema_1.AssetManifestSchema.currentVersion(),
            dockerImages: {
                theAsset: {
                    source: {
                        directory: absoluteDockerPath
                    },
                    destinations: {
                        theDestination: {
                            region: 'us-north-50',
                            assumeRoleArn: 'arn:aws:role',
                            repositoryName: 'repo',
                            imageTag: 'abcdef',
                        },
                    },
                },
            },
        }),
    });
    aws = mock_aws_1.mockAws();
});
afterEach(() => {
    mockfs.restore();
});
test('pass destination properties to AWS client', async () => {
    const pub = new lib_1.AssetPublishing(lib_1.AssetManifest.fromPath('/simple/cdk.out'), { aws, throwOnError: false });
    await pub.publish();
    expect(aws.ecrClient).toHaveBeenCalledWith(expect.objectContaining({
        region: 'us-north-50',
        assumeRoleArn: 'arn:aws:role',
    }));
});
describe('with a complete manifest', () => {
    let pub;
    beforeEach(() => {
        pub = new lib_1.AssetPublishing(lib_1.AssetManifest.fromPath('/simple/cdk.out'), { aws });
    });
    test('Do nothing if docker image already exists', async () => {
        aws.mockEcr.describeImages = mock_aws_1.mockedApiResult({ /* No error == image exists */});
        await pub.publish();
        expect(aws.mockEcr.describeImages).toHaveBeenCalledWith(expect.objectContaining({
            imageIds: [{ imageTag: 'abcdef' }],
            repositoryName: 'repo'
        }));
    });
    test('upload docker image if not uploaded yet but exists locally', async () => {
        aws.mockEcr.describeImages = mock_aws_1.mockedApiFailure('ImageNotFoundException', 'File does not exist');
        aws.mockEcr.getAuthorizationToken = mock_aws_1.mockedApiResult({
            authorizationData: [
                { authorizationToken: 'dXNlcjpwYXNz', proxyEndpoint: 'https://proxy.com/' }
            ]
        });
        mock_child_process_1.mockSpawn({ commandLine: ['docker', 'login', '--username', 'user', '--password-stdin', 'https://proxy.com/'] }, { commandLine: ['docker', 'inspect', 'cdkasset-theasset'] }, { commandLine: ['docker', 'tag', 'cdkasset-theasset', '12345.amazonaws.com/repo:abcdef'] }, { commandLine: ['docker', 'push', '12345.amazonaws.com/repo:abcdef'] });
        await pub.publish();
    });
    test('build and upload docker image if not exists anywhere', async () => {
        aws.mockEcr.describeImages = mock_aws_1.mockedApiFailure('ImageNotFoundException', 'File does not exist');
        aws.mockEcr.getAuthorizationToken = mock_aws_1.mockedApiResult({
            authorizationData: [
                { authorizationToken: 'dXNlcjpwYXNz', proxyEndpoint: 'https://proxy.com/' }
            ]
        });
        mock_child_process_1.mockSpawn({ commandLine: ['docker', 'login', '--username', 'user', '--password-stdin', 'https://proxy.com/'] }, { commandLine: ['docker', 'inspect', 'cdkasset-theasset'], exitCode: 1 }, { commandLine: ['docker', 'build', '--tag', 'cdkasset-theasset', '.'], cwd: absoluteDockerPath }, { commandLine: ['docker', 'tag', 'cdkasset-theasset', '12345.amazonaws.com/repo:abcdef'] }, { commandLine: ['docker', 'push', '12345.amazonaws.com/repo:abcdef'] });
        await pub.publish();
    });
});
test('correctly identify Docker directory if path is absolute', async () => {
    const pub = new lib_1.AssetPublishing(lib_1.AssetManifest.fromPath('/abs/cdk.out'), { aws });
    aws.mockEcr.describeImages = mock_aws_1.mockedApiFailure('ImageNotFoundException', 'File does not exist');
    aws.mockEcr.getAuthorizationToken = mock_aws_1.mockedApiResult({
        authorizationData: [
            { authorizationToken: 'dXNlcjpwYXNz', proxyEndpoint: 'https://proxy.com/' }
        ]
    });
    mock_child_process_1.mockSpawn(
    // Only care about the 'build' command line
    { commandLine: ['docker', 'login'], prefix: true, }, { commandLine: ['docker', 'inspect'], exitCode: 1, prefix: true }, { commandLine: ['docker', 'build', '--tag', 'cdkasset-theasset', '.'], cwd: absoluteDockerPath }, { commandLine: ['docker', 'tag'], prefix: true }, { commandLine: ['docker', 'push'], prefix: true });
    await pub.publish();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9ja2VyLWltYWdlcy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZG9ja2VyLWltYWdlcy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUUzQixrRUFBaUU7QUFDakUsa0NBQWtDO0FBQ2xDLGdDQUF3RDtBQUN4RCx5Q0FBd0U7QUFDeEUsNkRBQWlEO0FBRWpELElBQUksR0FBK0IsQ0FBQztBQUNwQyxNQUFNLGtCQUFrQixHQUFHLDJCQUEyQixDQUFDO0FBQ3ZELFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxNQUFNLENBQUM7UUFDTCw2QkFBNkIsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQzVDLE9BQU8sRUFBRSx1Q0FBbUIsQ0FBQyxjQUFjLEVBQUU7WUFDN0MsWUFBWSxFQUFFO2dCQUNaLFFBQVEsRUFBRTtvQkFDUixNQUFNLEVBQUU7d0JBQ04sU0FBUyxFQUFFLFdBQVc7cUJBQ3ZCO29CQUNELFlBQVksRUFBRTt3QkFDWixjQUFjLEVBQUU7NEJBQ2QsTUFBTSxFQUFFLGFBQWE7NEJBQ3JCLGFBQWEsRUFBRSxjQUFjOzRCQUM3QixjQUFjLEVBQUUsTUFBTTs0QkFDdEIsUUFBUSxFQUFFLFFBQVE7eUJBQ25CO3FCQUNGO2lCQUNGO2FBQ0Y7U0FDRixDQUFDO1FBQ0Ysc0NBQXNDLEVBQUUsY0FBYztRQUN0RCwwQkFBMEIsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ3pDLE9BQU8sRUFBRSx1Q0FBbUIsQ0FBQyxjQUFjLEVBQUU7WUFDN0MsWUFBWSxFQUFFO2dCQUNaLFFBQVEsRUFBRTtvQkFDUixNQUFNLEVBQUU7d0JBQ04sU0FBUyxFQUFFLGtCQUFrQjtxQkFDOUI7b0JBQ0QsWUFBWSxFQUFFO3dCQUNaLGNBQWMsRUFBRTs0QkFDZCxNQUFNLEVBQUUsYUFBYTs0QkFDckIsYUFBYSxFQUFFLGNBQWM7NEJBQzdCLGNBQWMsRUFBRSxNQUFN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QkFBZ0IsQ0FBQyx3QkFBd0IsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO0lBQy9GLEdBQUcsQ0FBQyxPQUFPLENBQUMscUJBQXFCLEdBQUcsMEJBQWUsQ0FBQztRQUNsRCxpQkFBaUIsRUFBRTtZQUNqQixFQUFFLGtCQUFrQixFQUFFLGNBQWMsRUFBRSxhQUFhLEVBQUUsb0JBQW9CLEVBQUU7U0FDNUU7S0FDRixDQUFDLENBQUM7SUFFSCw4QkFBUztJQUNQLDJDQUEyQztJQUMzQyxFQUFFLFdBQVcsRUFBRSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxHQUFHLEVBQ25ELEVBQUUsV0FBVyxFQUFFLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxFQUNqRSxFQUFFLFdBQVcsRUFBRSxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLEdBQUcsQ0FBQyxFQUFFLEdBQUcsRUFBRSxrQkFBa0IsRUFBRSxFQUNoRyxFQUFFLFdBQVcsRUFBRSxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEVBQ2hELEVBQUUsV0FBVyxFQUFFLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FDbEQsQ0FBQztJQUVGLE1BQU0sR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ3RCLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiamVzdC5tb2NrKCdjaGlsZF9wcm9jZXNzJyk7XG5cbmltcG9ydCB7IEFzc2V0TWFuaWZlc3RTY2hlbWEgfSBmcm9tICdAYXdzLWNkay9jZGstYXNzZXRzLXNjaGVtYSc7XG5pbXBvcnQgKiBhcyBtb2NrZnMgZnJvbSAnbW9jay1mcyc7XG5pbXBvcnQgeyBBc3NldE1hbmlmZXN0LCBBc3NldFB1Ymxpc2hpbmcgfSBmcm9tICcuLi9saWInO1xuaW1wb3J0IHsgbW9ja0F3cywgbW9ja2VkQXBpRmFpbHVyZSwgbW9ja2VkQXBpUmVzdWx0IH0gZnJvbSAnLi9tb2NrLWF3cyc7XG5pbXBvcnQgeyBtb2NrU3Bhd24gfSBmcm9tICcuL21vY2stY2hpbGRfcHJvY2Vzcyc7XG5cbmxldCBhd3M6IFJldHVyblR5cGU8dHlwZW9mIG1vY2tBd3M+O1xuY29uc3QgYWJzb2x1dGVEb2NrZXJQYXRoID0gJy9zaW1wbGUvY2RrLm91dC9kb2NrZXJkaXInO1xuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIG1vY2tmcyh7XG4gICAgJy9zaW1wbGUvY2RrLm91dC9hc3NldHMuanNvbic6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIHZlcnNpb246IEFzc2V0TWFuaWZlc3RTY2hlbWEuY3VycmVudFZlcnNpb24oKSxcbiAgICAgIGRvY2tlckltYWdlczoge1xuICAgICAgICB0aGVBc3NldDoge1xuICAgICAgICAgIHNvdXJjZToge1xuICAgICAgICAgICAgZGlyZWN0b3J5OiAnZG9ja2VyZGlyJ1xuICAgICAgICAgIH0sXG4gICAgICAgICAgZGVzdGluYXRpb25zOiB7XG4gICAgICAgICAgICB0aGVEZXN0aW5hdGlvbjoge1xuICAgICAgICAgICAgICByZWdpb246ICd1cy1ub3J0aC01MCcsXG4gICAgICAgICAgICAgIGFzc3VtZVJvbGVBcm46ICdhcm46YXdzOnJvbGUnLFxuICAgICAgICAgICAgICByZXBvc2l0b3J5TmFtZTogJ3JlcG8nLFxuICAgICAgICAgICAgICBpbWFnZVRhZzogJ2FiY2RlZicsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pLFxuICAgICcvc2ltcGxlL2Nkay5vdXQvZG9ja2VyZGlyL0RvY2tlcmZpbGUnOiAnRlJPTSBzY3JhdGNoJyxcbiAgICAnL2Ficy9jZGsub3V0L2Fzc2V0cy5qc29uJzogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgdmVyc2lvbjogQXNzZXRNYW5pZmVzdFNjaGVtYS5jdXJyZW50VmVyc2lvbigpLFxuICAgICAgZG9ja2VySW1hZ2VzOiB7XG4gICAgICAgIHRoZUFzc2V0OiB7XG4gICAgICAgICAgc291cmNlOiB7XG4gICAgICAgICAgICBkaXJlY3Rvcnk6IGFic29sdXRlRG9ja2VyUGF0aFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZGVzdGluYXRpb25zOiB7XG4gICAgICAgICAgICB0aGVEZXN0aW5hdGlvbjoge1xuICAgICAgICAgICAgICByZWdpb246ICd1cy1ub3J0aC01MCcsXG4gICAgICAgICAgICAgIGFzc3VtZVJvbGVBcm46ICdhcm46YXdzOnJvbGUnLFxuICAgICAgICAgICAgICByZXBvc2l0b3J5TmFtZTogJ3JlcG8nLFxuICAgICAgICAgICAgICBpbWFnZVRhZzogJ2FiY2RlZicsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pLFxuICB9KTtcblxuICBhd3MgPSBtb2NrQXdzKCk7XG59KTtcblxuYWZ0ZXJFYWNoKCgpID0+IHtcbiAgbW9ja2ZzLnJlc3RvcmUoKTtcbn0pO1xuXG50ZXN0KCdwYXNzIGRlc3RpbmF0aW9uIHByb3BlcnRpZXMgdG8gQVdTIGNsaWVudCcsIGFzeW5jICgpID0+IHtcbiAgY29uc3QgcHViID0gbmV3IEFzc2V0UHVibGlzaGluZyhBc3NldE1hbmlmZXN0LmZyb21QYXRoKCcvc2ltcGxlL2Nkay5vdXQnKSwgeyBhd3MsIHRocm93T25FcnJvcjogZmFsc2UgfSk7XG5cbiAgYXdhaXQgcHViLnB1Ymxpc2goKTtcblxuICBleHBlY3QoYXdzLmVjckNsaWVudCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgIHJlZ2lvbjogJ3VzLW5vcnRoLTUwJyxcbiAgICBhc3N1bWVSb2xlQXJuOiAnYXJuOmF3czpyb2xlJyxcbiAgfSkpO1xufSk7XG5cbmRlc2NyaWJlKCd3aXRoIGEgY29tcGxldGUgbWFuaWZlc3QnLCAoKSA9PiB7XG4gIGxldCBwdWI6IEFzc2V0UHVibGlzaGluZztcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgcHViID0gbmV3IEFzc2V0UHVibGlzaGluZyhBc3NldE1hbmlmZXN0LmZyb21QYXRoKCcvc2ltcGxlL2Nkay5vdXQnKSwgeyBhd3MgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ0RvIG5vdGhpbmcgaWYgZG9ja2VyIGltYWdlIGFscmVhZHkgZXhpc3RzJywgYXN5bmMgKCkgPT4ge1xuICAgIGF3cy5tb2NrRWNyLmRlc2NyaWJlSW1hZ2VzID0gbW9ja2VkQXBpUmVzdWx0KHsgLyogTm8gZXJyb3IgPT0gaW1hZ2UgZXhpc3RzICovIH0pO1xuXG4gICAgYXdhaXQgcHViLnB1Ymxpc2goKTtcblxuICAgIGV4cGVjdChhd3MubW9ja0Vjci5kZXNjcmliZUltYWdlcykudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgaW1hZ2VJZHM6IFt7aW1hZ2VUYWc6ICdhYmNkZWYnfV0sXG4gICAgICByZXBvc2l0b3J5TmFtZTogJ3JlcG8nXG4gICAgfSkpO1xuICB9KTtcblxuICB0ZXN0KCd1cGxvYWQgZG9ja2VyIGltYWdlIGlmIG5vdCB1cGxvYWRlZCB5ZXQgYnV0IGV4aXN0cyBsb2NhbGx5JywgYXN5bmMgKCkgPT4ge1xuICAgIGF3cy5tb2NrRWNyLmRlc2NyaWJlSW1hZ2VzID0gbW9ja2VkQXBpRmFpbHVyZSgnSW1hZ2VOb3RGb3VuZEV4Y2VwdGlvbicsICdGaWxlIGRvZXMgbm90IGV4aXN0Jyk7XG4gICAgYXdzLm1vY2tFY3IuZ2V0QXV0aG9yaXphdGlvblRva2VuID0gbW9ja2VkQXBpUmVzdWx0KHtcbiAgICAgIGF1dGhvcml6YXRpb25EYXRhOiBbXG4gICAgICAgIHsgYXV0aG9yaXphdGlvblRva2VuOiAnZFhObGNqcHdZWE56JywgcHJveHlFbmRwb2ludDogJ2h0dHBzOi8vcHJveHkuY29tLycgfVxuICAgICAgXVxuICAgIH0pO1xuXG4gICAgbW9ja1NwYXduKFxuICAgICAgeyBjb21tYW5kTGluZTogWydkb2NrZXInLCAnbG9naW4nLCAnLS11c2VybmFtZScsICd1c2VyJywgJy0tcGFzc3dvcmQtc3RkaW4nLCAnaHR0cHM6Ly9wcm94eS5jb20vJ10gfSxcbiAgICAgIHsgY29tbWFuZExpbmU6IFsnZG9ja2VyJywgJ2luc3BlY3QnLCAnY2RrYXNzZXQtdGhlYXNzZXQnXSB9LFxuICAgICAgeyBjb21tYW5kTGluZTogWydkb2NrZXInLCAndGFnJywgJ2Nka2Fzc2V0LXRoZWFzc2V0JywgJzEyMzQ1LmFtYXpvbmF3cy5jb20vcmVwbzphYmNkZWYnXSB9LFxuICAgICAgeyBjb21tYW5kTGluZTogWydkb2NrZXInLCAncHVzaCcsICcxMjM0NS5hbWF6b25hd3MuY29tL3JlcG86YWJjZGVmJ10gfSxcbiAgICApO1xuXG4gICAgYXdhaXQgcHViLnB1Ymxpc2goKTtcbiAgfSk7XG5cbiAgdGVzdCgnYnVpbGQgYW5kIHVwbG9hZCBkb2NrZXIgaW1hZ2UgaWYgbm90IGV4aXN0cyBhbnl3aGVyZScsIGFzeW5jICgpID0+IHtcbiAgICBhd3MubW9ja0Vjci5kZXNjcmliZUltYWdlcyA9IG1vY2tlZEFwaUZhaWx1cmUoJ0ltYWdlTm90Rm91bmRFeGNlcHRpb24nLCAnRmlsZSBkb2VzIG5vdCBleGlzdCcpO1xuICAgIGF3cy5tb2NrRWNyLmdldEF1dGhvcml6YXRpb25Ub2tlbiA9IG1vY2tlZEFwaVJlc3VsdCh7XG4gICAgICBhdXRob3JpemF0aW9uRGF0YTogW1xuICAgICAgICB7IGF1dGhvcml6YXRpb25Ub2tlbjogJ2RYTmxjanB3WVhOeicsIHByb3h5RW5kcG9pbnQ6ICdodHRwczovL3Byb3h5LmNvbS8nIH1cbiAgICAgIF1cbiAgICB9KTtcblxuICAgIG1vY2tTcGF3bihcbiAgICAgIHsgY29tbWFuZExpbmU6IFsnZG9ja2VyJywgJ2xvZ2luJywgJy0tdXNlcm5hbWUnLCAndXNlcicsICctLXBhc3N3b3JkLXN0ZGluJywgJ2h0dHBzOi8vcHJveHkuY29tLyddIH0sXG4gICAgICB7IGNvbW1hbmRMaW5lOiBbJ2RvY2tlcicsICdpbnNwZWN0JywgJ2Nka2Fzc2V0LXRoZWFzc2V0J10sIGV4aXRDb2RlOiAxIH0sXG4gICAgICB7IGNvbW1hbmRMaW5lOiBbJ2RvY2tlcicsICdidWlsZCcsICctLXRhZycsICdjZGthc3NldC10aGVhc3NldCcsICcuJ10sIGN3ZDogYWJzb2x1dGVEb2NrZXJQYXRoIH0sXG4gICAgICB7IGNvbW1hbmRMaW5lOiBbJ2RvY2tlcicsICd0YWcnLCAnY2RrYXNzZXQtdGhlYXNzZXQnLCAnMTIzNDUuYW1hem9uYXdzLmNvbS9yZXBvOmFiY2RlZiddIH0sXG4gICAgICB7IGNvbW1hbmRMaW5lOiBbJ2RvY2tlcicsICdwdXNoJywgJzEyMzQ1LmFtYXpvbmF3cy5jb20vcmVwbzphYmNkZWYnXSB9LFxuICAgICk7XG5cbiAgICBhd2FpdCBwdWIucHVibGlzaCgpO1xuICB9KTtcbn0pO1xuXG50ZXN0KCdjb3JyZWN0bHkgaWRlbnRpZnkgRG9ja2VyIGRpcmVjdG9yeSBpZiBwYXRoIGlzIGFic29sdXRlJywgYXN5bmMgKCkgPT4ge1xuICBjb25zdCBwdWIgPSBuZXcgQXNzZXRQdWJsaXNoaW5nKEFzc2V0TWFuaWZlc3QuZnJvbVBhdGgoJy9hYnMvY2RrLm91dCcpLCB7IGF3cyB9KTtcblxuICBhd3MubW9ja0Vjci5kZXNjcmliZUltYWdlcyA9IG1vY2tlZEFwaUZhaWx1cmUoJ0ltYWdlTm90Rm91bmRFeGNlcHRpb24nLCAnRmlsZSBkb2VzIG5vdCBleGlzdCcpO1xuICBhd3MubW9ja0Vjci5nZXRBdXRob3JpemF0aW9uVG9rZW4gPSBtb2NrZWRBcGlSZXN1bHQoe1xuICAgIGF1dGhvcml6YXRpb25EYXRhOiBbXG4gICAgICB7IGF1dGhvcml6YXRpb25Ub2tlbjogJ2RYTmxjanB3WVhOeicsIHByb3h5RW5kcG9pbnQ6ICdodHRwczovL3Byb3h5LmNvbS8nIH1cbiAgICBdXG4gIH0pO1xuXG4gIG1vY2tTcGF3bihcbiAgICAvLyBPbmx5IGNhcmUgYWJvdXQgdGhlICdidWlsZCcgY29tbWFuZCBsaW5lXG4gICAgeyBjb21tYW5kTGluZTogWydkb2NrZXInLCAnbG9naW4nXSwgcHJlZml4OiB0cnVlLCB9LFxuICAgIHsgY29tbWFuZExpbmU6IFsnZG9ja2VyJywgJ2luc3BlY3QnXSwgZXhpdENvZGU6IDEsIHByZWZpeDogdHJ1ZSB9LFxuICAgIHsgY29tbWFuZExpbmU6IFsnZG9ja2VyJywgJ2J1aWxkJywgJy0tdGFnJywgJ2Nka2Fzc2V0LXRoZWFzc2V0JywgJy4nXSwgY3dkOiBhYnNvbHV0ZURvY2tlclBhdGggfSxcbiAgICB7IGNvbW1hbmRMaW5lOiBbJ2RvY2tlcicsICd0YWcnXSwgcHJlZml4OiB0cnVlIH0sXG4gICAgeyBjb21tYW5kTGluZTogWydkb2NrZXInLCAncHVzaCddLCBwcmVmaXg6IHRydWUgfSxcbiAgKTtcblxuICBhd2FpdCBwdWIucHVibGlzaCgpO1xufSk7XG4iXX0=