"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('aws-sdk');
const AWS = require("aws-sdk");
function mockAws() {
    const mockEcr = new AWS.ECR();
    const mockS3 = new AWS.S3();
    // Sane defaults which can be overridden
    mockS3.getBucketLocation = mockedApiResult({});
    mockEcr.describeRepositories = mockedApiResult({ repositories: [
            {
                repositoryUri: '12345.amazonaws.com/repo'
            }
        ] });
    return {
        mockEcr,
        mockS3,
        discoverCurrentAccount: jest.fn(() => Promise.resolve({ accountId: 'current_account', partition: 'swa' })),
        discoverDefaultRegion: jest.fn(() => Promise.resolve('current_region')),
        ecrClient: jest.fn().mockReturnValue(Promise.resolve(mockEcr)),
        s3Client: jest.fn().mockReturnValue(Promise.resolve(mockS3)),
    };
}
exports.mockAws = mockAws;
function errorWithCode(code, message) {
    const ret = new Error(message);
    ret.code = code;
    return ret;
}
exports.errorWithCode = errorWithCode;
function mockedApiResult(returnValue) {
    return jest.fn().mockReturnValue({
        promise: jest.fn().mockResolvedValue(returnValue)
    });
}
exports.mockedApiResult = mockedApiResult;
function mockedApiFailure(code, message) {
    return jest.fn().mockReturnValue({
        promise: jest.fn().mockRejectedValue(errorWithCode(code, message))
    });
}
exports.mockedApiFailure = mockedApiFailure;
/**
 * Mock upload, draining the stream that we get before returning
 * so no race conditions happen with the uninstallation of mock-fs.
 */
function mockUpload(expectContent) {
    return jest.fn().mockImplementation(request => ({
        promise: () => new Promise((ok, ko) => {
            const didRead = new Array();
            const bodyStream = request.Body;
            bodyStream.on('data', (chunk) => { didRead.push(chunk.toString()); }); // This listener must exist
            bodyStream.on('error', ko);
            bodyStream.on('close', () => {
                const actualContent = didRead.join('');
                if (expectContent !== undefined && expectContent !== actualContent) {
                    throw new Error(`Expected to read '${expectContent}' but read: '${actualContent}'`);
                }
                ok();
            });
        })
    }));
}
exports.mockUpload = mockUpload;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9jay1hd3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtb2NrLWF3cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDckIsK0JBQStCO0FBRS9CLFNBQWdCLE9BQU87SUFDckIsTUFBTSxPQUFPLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDOUIsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUM7SUFFNUIsd0NBQXdDO0lBQ3hDLE1BQU0sQ0FBQyxpQkFBaUIsR0FBRyxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDL0MsT0FBTyxDQUFDLG9CQUFvQixHQUFHLGVBQWUsQ0FBQyxFQUFFLFlBQVksRUFBRTtZQUM3RDtnQkFDRSxhQUFhLEVBQUUsMEJBQTBCO2FBQzFDO1NBQ0YsRUFBRSxDQUFDLENBQUM7SUFFTCxPQUFPO1FBQ0wsT0FBTztRQUNQLE1BQU07UUFDTixzQkFBc0IsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxTQUFTLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDMUcscUJBQXFCLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDdkUsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM5RCxRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0tBQzdELENBQUM7QUFDSixDQUFDO0FBcEJELDBCQW9CQztBQUVELFNBQWdCLGFBQWEsQ0FBQyxJQUFZLEVBQUUsT0FBZTtJQUN6RCxNQUFNLEdBQUcsR0FBRyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM5QixHQUFXLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUN6QixPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUM7QUFKRCxzQ0FJQztBQUVELFNBQWdCLGVBQWUsQ0FBQyxXQUFnQjtJQUM5QyxPQUFPLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUM7UUFDL0IsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUM7S0FDbEQsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUpELDBDQUlDO0FBRUQsU0FBZ0IsZ0JBQWdCLENBQUMsSUFBWSxFQUFFLE9BQWU7SUFDNUQsT0FBTyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO1FBQy9CLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztLQUNuRSxDQUFDLENBQUM7QUFDTCxDQUFDO0FBSkQsNENBSUM7QUFFRDs7O0dBR0c7QUFDSCxTQUFnQixVQUFVLENBQUMsYUFBc0I7SUFDL0MsT0FBTyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzlDLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRTtZQUNwQyxNQUFNLE9BQU8sR0FBRyxJQUFJLEtBQUssRUFBVSxDQUFDO1lBRXBDLE1BQU0sVUFBVSxHQUEwQixPQUFPLENBQUMsSUFBSSxDQUFDO1lBQ3ZELFVBQVUsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQywyQkFBMkI7WUFDbEcsVUFBVSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDM0IsVUFBVSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO2dCQUMxQixNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN2QyxJQUFJLGFBQWEsS0FBSyxTQUFTLElBQUksYUFBYSxLQUFLLGFBQWEsRUFBRTtvQkFDbEUsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQkFBcUIsYUFBYSxnQkFBZ0IsYUFBYSxHQUFHLENBQUMsQ0FBQztpQkFDckY7Z0JBQ0QsRUFBRSxFQUFFLENBQUM7WUFDUCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQztLQUNILENBQUMsQ0FBQyxDQUFDO0FBQ04sQ0FBQztBQWpCRCxnQ0FpQkMiLCJzb3VyY2VzQ29udGVudCI6WyJqZXN0Lm1vY2soJ2F3cy1zZGsnKTtcbmltcG9ydCAqIGFzIEFXUyBmcm9tICdhd3Mtc2RrJztcblxuZXhwb3J0IGZ1bmN0aW9uIG1vY2tBd3MoKSB7XG4gIGNvbnN0IG1vY2tFY3IgPSBuZXcgQVdTLkVDUigpO1xuICBjb25zdCBtb2NrUzMgPSBuZXcgQVdTLlMzKCk7XG5cbiAgLy8gU2FuZSBkZWZhdWx0cyB3aGljaCBjYW4gYmUgb3ZlcnJpZGRlblxuICBtb2NrUzMuZ2V0QnVja2V0TG9jYXRpb24gPSBtb2NrZWRBcGlSZXN1bHQoe30pO1xuICBtb2NrRWNyLmRlc2NyaWJlUmVwb3NpdG9yaWVzID0gbW9ja2VkQXBpUmVzdWx0KHsgcmVwb3NpdG9yaWVzOiBbXG4gICAge1xuICAgICAgcmVwb3NpdG9yeVVyaTogJzEyMzQ1LmFtYXpvbmF3cy5jb20vcmVwbydcbiAgICB9XG4gIF0gfSk7XG5cbiAgcmV0dXJuIHtcbiAgICBtb2NrRWNyLFxuICAgIG1vY2tTMyxcbiAgICBkaXNjb3ZlckN1cnJlbnRBY2NvdW50OiBqZXN0LmZuKCgpID0+IFByb21pc2UucmVzb2x2ZSh7IGFjY291bnRJZDogJ2N1cnJlbnRfYWNjb3VudCcsIHBhcnRpdGlvbjogJ3N3YScgfSkpLFxuICAgIGRpc2NvdmVyRGVmYXVsdFJlZ2lvbjogamVzdC5mbigoKSA9PiBQcm9taXNlLnJlc29sdmUoJ2N1cnJlbnRfcmVnaW9uJykpLFxuICAgIGVjckNsaWVudDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShQcm9taXNlLnJlc29sdmUobW9ja0VjcikpLFxuICAgIHMzQ2xpZW50OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZShtb2NrUzMpKSxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGVycm9yV2l0aENvZGUoY29kZTogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcpIHtcbiAgY29uc3QgcmV0ID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xuICAocmV0IGFzIGFueSkuY29kZSA9IGNvZGU7XG4gIHJldHVybiByZXQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtb2NrZWRBcGlSZXN1bHQocmV0dXJuVmFsdWU6IGFueSkge1xuICByZXR1cm4gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgcHJvbWlzZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHJldHVyblZhbHVlKVxuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1vY2tlZEFwaUZhaWx1cmUoY29kZTogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcpIHtcbiAgcmV0dXJuIGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgIHByb21pc2U6IGplc3QuZm4oKS5tb2NrUmVqZWN0ZWRWYWx1ZShlcnJvcldpdGhDb2RlKGNvZGUsIG1lc3NhZ2UpKVxuICB9KTtcbn1cblxuLyoqXG4gKiBNb2NrIHVwbG9hZCwgZHJhaW5pbmcgdGhlIHN0cmVhbSB0aGF0IHdlIGdldCBiZWZvcmUgcmV0dXJuaW5nXG4gKiBzbyBubyByYWNlIGNvbmRpdGlvbnMgaGFwcGVuIHdpdGggdGhlIHVuaW5zdGFsbGF0aW9uIG9mIG1vY2stZnMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBtb2NrVXBsb2FkKGV4cGVjdENvbnRlbnQ/OiBzdHJpbmcpIHtcbiAgcmV0dXJuIGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24ocmVxdWVzdCA9PiAoe1xuICAgIHByb21pc2U6ICgpID0+IG5ldyBQcm9taXNlKChvaywga28pID0+IHtcbiAgICAgIGNvbnN0IGRpZFJlYWQgPSBuZXcgQXJyYXk8c3RyaW5nPigpO1xuXG4gICAgICBjb25zdCBib2R5U3RyZWFtOiBOb2RlSlMuUmVhZGFibGVTdHJlYW0gPSByZXF1ZXN0LkJvZHk7XG4gICAgICBib2R5U3RyZWFtLm9uKCdkYXRhJywgKGNodW5rKSA9PiB7IGRpZFJlYWQucHVzaChjaHVuay50b1N0cmluZygpKTsgfSk7IC8vIFRoaXMgbGlzdGVuZXIgbXVzdCBleGlzdFxuICAgICAgYm9keVN0cmVhbS5vbignZXJyb3InLCBrbyk7XG4gICAgICBib2R5U3RyZWFtLm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgICAgY29uc3QgYWN0dWFsQ29udGVudCA9IGRpZFJlYWQuam9pbignJyk7XG4gICAgICAgIGlmIChleHBlY3RDb250ZW50ICE9PSB1bmRlZmluZWQgJiYgZXhwZWN0Q29udGVudCAhPT0gYWN0dWFsQ29udGVudCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgdG8gcmVhZCAnJHtleHBlY3RDb250ZW50fScgYnV0IHJlYWQ6ICcke2FjdHVhbENvbnRlbnR9J2ApO1xuICAgICAgICB9XG4gICAgICAgIG9rKCk7XG4gICAgICB9KTtcbiAgICB9KVxuICB9KSk7XG59Il19