"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const core = require("@aws-cdk/core");
const fs = require("fs-extra");
const path = require("path");
const api_1 = require("../../../lib/api");
const bootstrap_environment2_1 = require("../../../lib/api/bootstrap/bootstrap-environment2");
const my_test_cdk_stack_1 = require("./example-cdk-app/my-test-cdk-stack");
jest.setTimeout(600000);
describe('Bootstrapping', () => {
    const bootstrapStackName = 'AwsCdkBootstrapIntegTestLegacy';
    const account = requireEnvVariable('TEST_ACCOUNT');
    const region = requireEnvVariable('TEST_REGION');
    let s3;
    let env;
    let sdkProvider;
    let sdk;
    beforeAll(async () => {
        env = {
            name: 'aws-cdk-bootstrap-integ-test',
            account,
            region,
        };
        sdkProvider = await api_1.SdkProvider.withAwsCliCompatibleDefaults({
            httpOptions: {
                userAgent: 'aws-cdk-bootstrap-integ-test',
            }
        });
        sdk = await sdkProvider.forEnvironment(env.account, env.region, api_1.Mode.ForWriting);
        s3 = sdk.s3();
    });
    describe('deploys the legacy bootstrap stack', () => {
        const legacyBootstrapBucketName = 'aws-cdk-bootstrap-integ-test-legacy-bckt';
        const newBootstrapBucketName = 'aws-cdk-bootstrap-integ-test-v2-bckt';
        const exampleAppStack = 'BootstrapIntegTestExampleCdkAppStack';
        const outdir = path.join(__dirname, 'cdk.out');
        let bootstrapStack;
        let testStack;
        beforeAll(async () => {
            // bootstrap the "old" way
            const bootstrapResults = await api_1.bootstrapEnvironment(env, sdkProvider, bootstrapStackName, undefined, {
                bucketName: legacyBootstrapBucketName,
            });
            bootstrapStack = bootstrapResults.stackArtifact;
        });
        test('and then can deploy a CDK app using that bootstrap stack', async () => {
            testStack = await deployCdkApp(outdir, env, sdkProvider, sdk, bootstrapStackName, (app) => {
                new my_test_cdk_stack_1.MyTestCdkStack(app, exampleAppStack, {
                    assetType: my_test_cdk_stack_1.ExampleAsset.ASSET_1,
                    env,
                });
            });
        });
        describe('and then updates the bootstrap stack with the new resources', () => {
            beforeAll(async () => {
                // bootstrap the "new" way
                const bootstrapResults = await bootstrap_environment2_1.bootstrapEnvironment2(env, sdkProvider, bootstrapStackName, undefined, {
                    bucketName: newBootstrapBucketName,
                    trustedAccounts: ['790124522186', '593667001225'],
                    cloudFormationExecutionPolicies: [
                        'arn:aws:iam::aws:policy/AdministratorAccess',
                        'arn:aws:iam::aws:policy/AmazonS3FullAccess',
                    ],
                });
                bootstrapStack = bootstrapResults.stackArtifact;
            });
            test('can now update the CDK app with the new bootstrap stack', async () => {
                await deployCdkApp(outdir, env, sdkProvider, sdk, bootstrapStackName, (app) => {
                    new my_test_cdk_stack_1.MyTestCdkStack(app, exampleAppStack, {
                        assetType: my_test_cdk_stack_1.ExampleAsset.ASSET_2,
                        env,
                    });
                });
            });
            afterAll(async () => {
                // empty and delete the now orphaned previous bootstrap bucket
                await emptyBucket(s3, legacyBootstrapBucketName);
                return s3.deleteBucket({ Bucket: legacyBootstrapBucketName }).promise();
            });
        });
        afterAll(() => {
            // delete the test CDK app stack
            return api_1.destroyStack({
                stack: testStack,
                sdk,
            });
        });
        afterAll(async () => {
            // empty the bootstrap bucket -
            // otherwise, CloudFormation will fail to delete the bootstrap stack
            await emptyBucket(s3, newBootstrapBucketName);
            return api_1.destroyStack({
                stack: bootstrapStack,
                sdk,
            });
        });
    });
});
function requireEnvVariable(variableName) {
    const ret = process.env[variableName];
    if (!ret) {
        throw new Error(`It is mandatory to set the '${variableName}' environment variable before running this test`);
    }
    return ret;
}
async function deployCdkApp(outdir, env, sdkProvider, sdk, bootstrapStackName, cdkCode) {
    // clean the output directory, just to make 100% sure there is no junk left there
    await fs.remove(outdir);
    // synthesize an app to a local cdk.out
    const app = new core.App({ outdir });
    cdkCode(app);
    const assembly = app.synth();
    // now deploy the synthesized app
    const toolkitInfo = await api_1.ToolkitInfo.lookup(env, sdk, bootstrapStackName);
    const testStack = assembly.stacks[0]; // we assume there's just one stack
    await api_1.deployStack({
        stack: testStack,
        resolvedEnvironment: env,
        toolkitInfo,
        sdkProvider,
        sdk,
    });
    return testStack;
}
async function emptyBucket(s3, bucketName) {
    const objects = await s3.listObjects({ Bucket: bucketName }).promise();
    const deletes = (objects.Contents || []).map(obj => obj.Key || '').filter(d => !!d);
    if (deletes.length === 0) {
        return Promise.resolve();
    }
    return s3.deleteObjects({
        Bucket: bucketName,
        Delete: {
            Objects: deletes.map(d => ({ Key: d })),
            Quiet: false,
        },
    }).promise();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9vdHN0cmFwLmludGVnLXRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJib290c3RyYXAuaW50ZWctdGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUFzQztBQUd0QywrQkFBK0I7QUFDL0IsNkJBQTZCO0FBQzdCLDBDQUF5SDtBQUN6SCw4RkFBMEY7QUFDMUYsMkVBQW1GO0FBRW5GLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTyxDQUFDLENBQUM7QUFFekIsUUFBUSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7SUFDN0IsTUFBTSxrQkFBa0IsR0FBRyxnQ0FBZ0MsQ0FBQztJQUU1RCxNQUFNLE9BQU8sR0FBRyxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNuRCxNQUFNLE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNqRCxJQUFJLEVBQVUsQ0FBQztJQUNmLElBQUksR0FBc0IsQ0FBQztJQUMzQixJQUFJLFdBQXdCLENBQUM7SUFDN0IsSUFBSSxHQUFTLENBQUM7SUFFZCxTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkIsR0FBRyxHQUFHO1lBQ0osSUFBSSxFQUFFLDhCQUE4QjtZQUNwQyxPQUFPO1lBQ1AsTUFBTTtTQUNQLENBQUM7UUFDRixXQUFXLEdBQUcsTUFBTSxpQkFBVyxDQUFDLDRCQUE0QixDQUFDO1lBQzNELFdBQVcsRUFBRTtnQkFDWCxTQUFTLEVBQUUsOEJBQThCO2FBQzFDO1NBQ0YsQ0FBQyxDQUFDO1FBQ0gsR0FBRyxHQUFHLE1BQU0sV0FBVyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxNQUFNLEVBQUUsVUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ2pGLEVBQUUsR0FBRyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDaEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsb0NBQW9DLEVBQUUsR0FBRyxFQUFF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WCxXQUFXO1FBQ1gsR0FBRztLQUNKLENBQUMsQ0FBQztJQUNILE9BQU8sU0FBUyxDQUFDO0FBQ25CLENBQUM7QUFFRCxLQUFLLFVBQVUsV0FBVyxDQUFDLEVBQVUsRUFBRSxVQUFrQjtJQUN2RCxNQUFNLE9BQU8sR0FBRyxNQUFNLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUN2RSxNQUFNLE9BQU8sR0FBRyxDQUFDLE9BQU8sQ0FBQyxRQUFRLElBQUksRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEYsSUFBSSxPQUFPLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUN4QixPQUFPLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztLQUMxQjtJQUNELE9BQU8sRUFBRSxDQUFDLGFBQWEsQ0FBQztRQUN0QixNQUFNLEVBQUUsVUFBVTtRQUNsQixNQUFNLEVBQUU7WUFDTixPQUFPLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN2QyxLQUFLLEVBQUUsS0FBSztTQUNiO0tBQ0YsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ2YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNvcmUgZnJvbSAnQGF3cy1jZGsvY29yZSc7XG5pbXBvcnQgKiBhcyBjeGFwaSBmcm9tICdAYXdzLWNkay9jeC1hcGknO1xuaW1wb3J0ICogYXMgQVdTIGZyb20gJ2F3cy1zZGsnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGJvb3RzdHJhcEVudmlyb25tZW50LCBkZXBsb3lTdGFjaywgZGVzdHJveVN0YWNrLCBJU0RLLCBNb2RlLCBTZGtQcm92aWRlciwgVG9vbGtpdEluZm8gfSBmcm9tICcuLi8uLi8uLi9saWIvYXBpJztcbmltcG9ydCB7IGJvb3RzdHJhcEVudmlyb25tZW50MiB9IGZyb20gJy4uLy4uLy4uL2xpYi9hcGkvYm9vdHN0cmFwL2Jvb3RzdHJhcC1lbnZpcm9ubWVudDInO1xuaW1wb3J0IHsgRXhhbXBsZUFzc2V0LCBNeVRlc3RDZGtTdGFjayB9IGZyb20gJy4vZXhhbXBsZS1jZGstYXBwL215LXRlc3QtY2RrLXN0YWNrJztcblxuamVzdC5zZXRUaW1lb3V0KDYwMF8wMDApO1xuXG5kZXNjcmliZSgnQm9vdHN0cmFwcGluZycsICgpID0+IHtcbiAgY29uc3QgYm9vdHN0cmFwU3RhY2tOYW1lID0gJ0F3c0Nka0Jvb3RzdHJhcEludGVnVGVzdExlZ2FjeSc7XG5cbiAgY29uc3QgYWNjb3VudCA9IHJlcXVpcmVFbnZWYXJpYWJsZSgnVEVTVF9BQ0NPVU5UJyk7XG4gIGNvbnN0IHJlZ2lvbiA9IHJlcXVpcmVFbnZWYXJpYWJsZSgnVEVTVF9SRUdJT04nKTtcbiAgbGV0IHMzOiBBV1MuUzM7XG4gIGxldCBlbnY6IGN4YXBpLkVudmlyb25tZW50O1xuICBsZXQgc2RrUHJvdmlkZXI6IFNka1Byb3ZpZGVyO1xuICBsZXQgc2RrOiBJU0RLO1xuXG4gIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gICAgZW52ID0ge1xuICAgICAgbmFtZTogJ2F3cy1jZGstYm9vdHN0cmFwLWludGVnLXRlc3QnLFxuICAgICAgYWNjb3VudCxcbiAgICAgIHJlZ2lvbixcbiAgICB9O1xuICAgIHNka1Byb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7XG4gICAgICBodHRwT3B0aW9uczoge1xuICAgICAgICB1c2VyQWdlbnQ6ICdhd3MtY2RrLWJvb3RzdHJhcC1pbnRlZy10ZXN0JyxcbiAgICAgIH1cbiAgICB9KTtcbiAgICBzZGsgPSBhd2FpdCBzZGtQcm92aWRlci5mb3JFbnZpcm9ubWVudChlbnYuYWNjb3VudCwgZW52LnJlZ2lvbiwgTW9kZS5Gb3JXcml0aW5nKTtcbiAgICBzMyA9IHNkay5zMygpO1xuICB9KTtcblxuICBkZXNjcmliZSgnZGVwbG95cyB0aGUgbGVnYWN5IGJvb3RzdHJhcCBzdGFjaycsICgpID0+IHtcbiAgICBjb25zdCBsZWdhY3lCb290c3RyYXBCdWNrZXROYW1lID0gJ2F3cy1jZGstYm9vdHN0cmFwLWludGVnLXRlc3QtbGVnYWN5LWJja3QnO1xuICAgIGNvbnN0IG5ld0Jvb3RzdHJhcEJ1Y2tldE5hbWUgPSAnYXdzLWNkay1ib290c3RyYXAtaW50ZWctdGVzdC12Mi1iY2t0JztcbiAgICBjb25zdCBleGFtcGxlQXBwU3RhY2sgPSAnQm9vdHN0cmFwSW50ZWdUZXN0RXhhbXBsZUNka0FwcFN0YWNrJztcbiAgICBjb25zdCBvdXRkaXIgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnY2RrLm91dCcpO1xuXG4gICAgbGV0IGJvb3RzdHJhcFN0YWNrOiBjeGFwaS5DbG91ZEZvcm1hdGlvblN0YWNrQXJ0aWZhY3Q7XG4gICAgbGV0IHRlc3RTdGFjazogY3hhcGkuQ2xvdWRGb3JtYXRpb25TdGFja0FydGlmYWN0O1xuXG4gICAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICAgIC8vIGJvb3RzdHJhcCB0aGUgXCJvbGRcIiB3YXlcbiAgICAgIGNvbnN0IGJvb3RzdHJhcFJlc3VsdHMgPSBhd2FpdCBib290c3RyYXBFbnZpcm9ubWVudChlbnYsIHNka1Byb3ZpZGVyLCBib290c3RyYXBTdGFja05hbWUsIHVuZGVmaW5lZCwge1xuICAgICAgICBidWNrZXROYW1lOiBsZWdhY3lCb290c3RyYXBCdWNrZXROYW1lLFxuICAgICAgfSk7XG4gICAgICBib290c3RyYXBTdGFjayA9IGJvb3RzdHJhcFJlc3VsdHMuc3RhY2tBcnRpZmFjdDtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2FuZCB0aGVuIGNhbiBkZXBsb3kgYSBDREsgYXBwIHVzaW5nIHRoYXQgYm9vdHN0cmFwIHN0YWNrJywgYXN5bmMgKCkgPT4ge1xuICAgICAgdGVzdFN0YWNrID0gYXdhaXQgZGVwbG95Q2RrQXBwKG91dGRpciwgZW52LCBzZGtQcm92aWRlciwgc2RrLCBib290c3RyYXBTdGFja05hbWUsIChhcHApID0+IHtcbiAgICAgICAgbmV3IE15VGVzdENka1N0YWNrKGFwcCwgZXhhbXBsZUFwcFN0YWNrLCB7XG4gICAgICAgICAgYXNzZXRUeXBlOiBFeGFtcGxlQXNzZXQuQVNTRVRfMSxcbiAgICAgICAgICBlbnYsXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnYW5kIHRoZW4gdXBkYXRlcyB0aGUgYm9vdHN0cmFwIHN0YWNrIHdpdGggdGhlIG5ldyByZXNvdXJjZXMnLCAoKSA9PiB7XG4gICAgICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgICAgICAvLyBib290c3RyYXAgdGhlIFwibmV3XCIgd2F5XG4gICAgICAgIGNvbnN0IGJvb3RzdHJhcFJlc3VsdHMgPSBhd2FpdCBib290c3RyYXBFbnZpcm9ubWVudDIoZW52LCBzZGtQcm92aWRlciwgYm9vdHN0cmFwU3RhY2tOYW1lLCB1bmRlZmluZWQsIHtcbiAgICAgICAgICBidWNrZXROYW1lOiBuZXdCb290c3RyYXBCdWNrZXROYW1lLFxuICAgICAgICAgIHRydXN0ZWRBY2NvdW50czogWyc3OTAxMjQ1MjIxODYnLCAnNTkzNjY3MDAxMjI1J10sXG4gICAgICAgICAgY2xvdWRGb3JtYXRpb25FeGVjdXRpb25Qb2xpY2llczogW1xuICAgICAgICAgICAgJ2Fybjphd3M6aWFtOjphd3M6cG9saWN5L0FkbWluaXN0cmF0b3JBY2Nlc3MnLFxuICAgICAgICAgICAgJ2Fybjphd3M6aWFtOjphd3M6cG9saWN5L0FtYXpvblMzRnVsbEFjY2VzcycsXG4gICAgICAgICAgXSxcbiAgICAgICAgfSk7XG4gICAgICAgIGJvb3RzdHJhcFN0YWNrID0gYm9vdHN0cmFwUmVzdWx0cy5zdGFja0FydGlmYWN0O1xuICAgICAgfSk7XG5cbiAgICAgIHRlc3QoJ2NhbiBub3cgdXBkYXRlIHRoZSBDREsgYXBwIHdpdGggdGhlIG5ldyBib290c3RyYXAgc3RhY2snLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IGRlcGxveUNka0FwcChvdXRkaXIsIGVudiwgc2RrUHJvdmlkZXIsIHNkaywgYm9vdHN0cmFwU3RhY2tOYW1lLCAoYXBwKSA9PiB7XG4gICAgICAgICAgbmV3IE15VGVzdENka1N0YWNrKGFwcCwgZXhhbXBsZUFwcFN0YWNrLCB7XG4gICAgICAgICAgICBhc3NldFR5cGU6IEV4YW1wbGVBc3NldC5BU1NFVF8yLFxuICAgICAgICAgICAgZW52LFxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBhZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgICAgIC8vIGVtcHR5IGFuZCBkZWxldGUgdGhlIG5vdyBvcnBoYW5lZCBwcmV2aW91cyBib290c3RyYXAgYnVja2V0XG4gICAgICAgIGF3YWl0IGVtcHR5QnVja2V0KHMzLCBsZWdhY3lCb290c3RyYXBCdWNrZXROYW1lKTtcbiAgICAgICAgcmV0dXJuIHMzLmRlbGV0ZUJ1Y2tldCh7IEJ1Y2tldDogbGVnYWN5Qm9vdHN0cmFwQnVja2V0TmFtZSB9KS5wcm9taXNlKCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGFmdGVyQWxsKCgpID0+IHtcbiAgICAgIC8vIGRlbGV0ZSB0aGUgdGVzdCBDREsgYXBwIHN0YWNrXG4gICAgICByZXR1cm4gZGVzdHJveVN0YWNrKHtcbiAgICAgICAgc3RhY2s6IHRlc3RTdGFjayxcbiAgICAgICAgc2RrLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBhZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgICAvLyBlbXB0eSB0aGUgYm9vdHN0cmFwIGJ1Y2tldCAtXG4gICAgICAvLyBvdGhlcndpc2UsIENsb3VkRm9ybWF0aW9uIHdpbGwgZmFpbCB0byBkZWxldGUgdGhlIGJvb3RzdHJhcCBzdGFja1xuICAgICAgYXdhaXQgZW1wdHlCdWNrZXQoczMsIG5ld0Jvb3RzdHJhcEJ1Y2tldE5hbWUpO1xuXG4gICAgICByZXR1cm4gZGVzdHJveVN0YWNrKHtcbiAgICAgICAgc3RhY2s6IGJvb3RzdHJhcFN0YWNrLFxuICAgICAgICBzZGssXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59KTtcblxuZnVuY3Rpb24gcmVxdWlyZUVudlZhcmlhYmxlKHZhcmlhYmxlTmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgcmV0ID0gcHJvY2Vzcy5lbnZbdmFyaWFibGVOYW1lXTtcbiAgaWYgKCFyZXQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEl0IGlzIG1hbmRhdG9yeSB0byBzZXQgdGhlICcke3ZhcmlhYmxlTmFtZX0nIGVudmlyb25tZW50IHZhcmlhYmxlIGJlZm9yZSBydW5uaW5nIHRoaXMgdGVzdGApO1xuICB9XG4gIHJldHVybiByZXQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRlcGxveUNka0FwcChcbiAgb3V0ZGlyOiBzdHJpbmcsIGVudjogY3hhcGkuRW52aXJvbm1lbnQsIHNka1Byb3ZpZGVyOiBTZGtQcm92aWRlcixcbiAgc2RrOiBJU0RLLCBib290c3RyYXBTdGFja05hbWU6IHN0cmluZywgY2RrQ29kZTogKGFwcDogY29yZS5BcHApID0+IHZvaWQpIHtcbiAgLy8gY2xlYW4gdGhlIG91dHB1dCBkaXJlY3RvcnksIGp1c3QgdG8gbWFrZSAxMDAlIHN1cmUgdGhlcmUgaXMgbm8ganVuayBsZWZ0IHRoZXJlXG4gIGF3YWl0IGZzLnJlbW92ZShvdXRkaXIpO1xuXG4gIC8vIHN5bnRoZXNpemUgYW4gYXBwIHRvIGEgbG9jYWwgY2RrLm91dFxuICBjb25zdCBhcHAgPSBuZXcgY29yZS5BcHAoeyBvdXRkaXIgfSk7XG4gIGNka0NvZGUoYXBwKTtcbiAgY29uc3QgYXNzZW1ibHkgPSBhcHAuc3ludGgoKTtcblxuICAvLyBub3cgZGVwbG95IHRoZSBzeW50aGVzaXplZCBhcHBcbiAgY29uc3QgdG9vbGtpdEluZm8gPSBhd2FpdCBUb29sa2l0SW5mby5sb29rdXAoZW52LCBzZGssIGJvb3RzdHJhcFN0YWNrTmFtZSk7XG4gIGNvbnN0IHRlc3RTdGFjayA9IGFzc2VtYmx5LnN0YWNrc1swXTsgLy8gd2UgYXNzdW1lIHRoZXJlJ3MganVzdCBvbmUgc3RhY2tcbiAgYXdhaXQgZGVwbG95U3RhY2soe1xuICAgIHN0YWNrOiB0ZXN0U3RhY2ssXG4gICAgcmVzb2x2ZWRFbnZpcm9ubWVudDogZW52LFxuICAgIHRvb2xraXRJbmZvLFxuICAgIHNka1Byb3ZpZGVyLFxuICAgIHNkayxcbiAgfSk7XG4gIHJldHVybiB0ZXN0U3RhY2s7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGVtcHR5QnVja2V0KHMzOiBBV1MuUzMsIGJ1Y2tldE5hbWU6IHN0cmluZykge1xuICBjb25zdCBvYmplY3RzID0gYXdhaXQgczMubGlzdE9iamVjdHMoeyBCdWNrZXQ6IGJ1Y2tldE5hbWUgfSkucHJvbWlzZSgpO1xuICBjb25zdCBkZWxldGVzID0gKG9iamVjdHMuQ29udGVudHMgfHwgW10pLm1hcChvYmogPT4gb2JqLktleSB8fCAnJykuZmlsdGVyKGQgPT4gISFkKTtcbiAgaWYgKGRlbGV0ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG4gIHJldHVybiBzMy5kZWxldGVPYmplY3RzKHtcbiAgICBCdWNrZXQ6IGJ1Y2tldE5hbWUsXG4gICAgRGVsZXRlOiB7XG4gICAgICBPYmplY3RzOiBkZWxldGVzLm1hcChkID0+ICh7IEtleTogZCB9KSksXG4gICAgICBRdWlldDogZmFsc2UsXG4gICAgfSxcbiAgfSkucHJvbWlzZSgpO1xufVxuIl19