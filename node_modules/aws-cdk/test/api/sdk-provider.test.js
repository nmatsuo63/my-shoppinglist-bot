"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cxapi = require("@aws-cdk/cx-api");
const AWS = require("aws-sdk");
const SDKMock = require("aws-sdk-mock");
const uuid = require("uuid");
const lib_1 = require("../../lib");
const aws_auth_1 = require("../../lib/api/aws-auth");
const logging = require("../../lib/logging");
const bockfs = require("../bockfs");
SDKMock.setSDKInstance(AWS);
logging.setVerbose(true);
const defaultCredOptions = {
    ec2creds: false,
    containerCreds: false,
};
// Account cache buster
let uid;
let pluginQueried = false;
beforeEach(() => {
    uid = `(${uuid.v4()})`;
    bockfs({
        '/home/me/.bxt/credentials': dedent(`
      [default]
      aws_access_key_id=${uid}access
      aws_secret_access_key=secret

      [foo]
      aws_access_key_id=${uid}fooccess
      aws_secret_access_key=secret

      [assumer]
      aws_access_key_id=${uid}assumer
      aws_secret_access_key=secret
    `),
        '/home/me/.bxt/config': dedent(`
      [default]
      region=eu-bla-5

      [profile foo]
      region=eu-west-1

      [profile boo]
      aws_access_key_id=${uid}booccess
      aws_secret_access_key=boocret
      # No region here

      [profile assumable]
      role_arn=arn:aws:iam::12356789012:role/Assumable
      source_profile=assumer

      [profile assumer]
      region=us-east-2
    `),
    });
    SDKMock.mock('STS', 'getCallerIdentity', (cb) => {
        return cb(null, {
            Account: `${uid}the_account_#`,
            UserId: 'you!',
            Arn: 'arn:aws-here:iam::12345:role/test'
        });
    });
    lib_1.PluginHost.instance.credentialProviderSources.splice(0);
    lib_1.PluginHost.instance.credentialProviderSources.push({
        isAvailable() { return Promise.resolve(true); },
        canProvideCredentials(account) { return Promise.resolve(account === `${uid}plugin_account_#`); },
        getProvider() {
            pluginQueried = true;
            return Promise.resolve(new AWS.Credentials({
                accessKeyId: `${uid}plugin_key`,
                secretAccessKey: 'plugin_secret',
                sessionToken: 'plugin_token',
            }));
        },
        name: 'test plugin',
    });
    // Set environment variables that we want
    process.env.AWS_CONFIG_FILE = bockfs.path('/home/me/.bxt/config');
    process.env.AWS_SHARED_CREDENTIALS_FILE = bockfs.path('/home/me/.bxt/credentials');
    // Scrub some environment variables that might be set if we're running on CodeBuild which will interfere with the tests.
    delete process.env.AWS_REGION;
    delete process.env.AWS_DEFAULT_REGION;
    delete process.env.AWS_ACCESS_KEY_ID;
    delete process.env.AWS_SECRET_ACCESS_KEY;
    delete process.env.AWS_SESSION_TOKEN;
});
afterEach(() => {
    SDKMock.restore();
    bockfs.restore();
});
describe('CLI compatible credentials loading', () => {
    test('default config credentials', async () => {
        // WHEN
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
        // THEN
        expect(provider.defaultRegion).toEqual('eu-bla-5');
        await expect(provider.defaultAccount()).resolves.toEqual({ accountId: `${uid}the_account_#`, partition: 'aws-here' });
        const sdk = await provider.forEnvironment(`${uid}the_account_#`, 'rgn', aws_auth_1.Mode.ForReading);
        expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}access`);
        expect(sdkConfig(sdk).region).toEqual('rgn');
    });
    test('unknown account and region uses current', async () => {
        // WHEN
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
        // THEN
        const sdk = await provider.forEnvironment(cxapi.UNKNOWN_ACCOUNT, cxapi.UNKNOWN_REGION, aws_auth_1.Mode.ForReading);
        expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}access`);
        expect(sdkConfig(sdk).region).toEqual('eu-bla-5');
    });
    test('mixed profile credentials', async () => {
        // WHEN
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions, profile: 'foo' });
        // THEN
        expect(provider.defaultRegion).toEqual('eu-west-1');
        await expect(provider.defaultAccount()).resolves.toEqual({ accountId: `${uid}the_account_#`, partition: 'aws-here' });
        const sdk = await provider.forEnvironment(`${uid}the_account_#`, 'def', aws_auth_1.Mode.ForReading);
        expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}fooccess`);
    });
    test('pure config credentials', async () => {
        // WHEN
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions, profile: 'boo' });
        // THEN
        expect(provider.defaultRegion).toEqual('eu-bla-5'); // Fall back to default config
        await expect(provider.defaultAccount()).resolves.toEqual({ accountId: `${uid}the_account_#`, partition: 'aws-here' });
        const sdk = await provider.forEnvironment(`${uid}the_account_#`, 'def', aws_auth_1.Mode.ForReading);
        expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}booccess`);
    });
    test('different account throws', async () => {
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions, profile: 'boo' });
        await expect(provider.forEnvironment(`${uid}some_account_#`, 'def', aws_auth_1.Mode.ForReading)).rejects.toThrow('Need to perform AWS calls');
    });
    test('even when using a profile to assume another profile, STS calls goes through the proxy', async () => {
        // Messy mocking
        let called = false;
        jest.mock('proxy-agent', () => {
            // eslint-disable-next-line @typescript-eslint/no-require-imports
            class FakeAgent extends require('https').Agent {
                addRequest(_, __) {
                    // FIXME: this error takes 6 seconds to be completely handled. It
                    // might be retries in the SDK somewhere, or something about the Node
                    // event loop. I've spent an hour trying to figure it out and I can't,
                    // and I gave up. We'll just have to live with this until someone gets
                    // inspired.
                    const error = new Error('ABORTED BY TEST');
                    error.code = 'RequestAbortedError';
                    error.retryable = false;
                    called = true;
                    throw error;
                }
            }
            return FakeAgent;
        });
        // WHEN
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions,
            ec2creds: false,
            profile: 'assumable',
            httpOptions: {
                proxyAddress: 'http://DOESNTMATTER/',
            }
        });
        await provider.defaultAccount();
        // THEN -- the fake proxy agent got called, we don't care about the result
        expect(called).toEqual(true);
    });
});
describe('Plugins', () => {
    test('does not use plugins if current credentials are for expected account', async () => {
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
        await provider.forEnvironment(`${uid}the_account_#`, 'def', aws_auth_1.Mode.ForReading);
        expect(pluginQueried).toEqual(false);
    });
    test('uses plugin for other account', async () => {
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
        await provider.forEnvironment(`${uid}plugin_account_#`, 'def', aws_auth_1.Mode.ForReading);
        expect(pluginQueried).toEqual(true);
    });
});
/**
 * Strip shared whitespace from the start of lines
 */
function dedent(x) {
    const lines = x.split('\n');
    while (lines.length > 0 && lines[0].trim() === '') {
        lines.shift();
    }
    while (lines.length > 0 && lines[lines.length - 1].trim() === '') {
        lines.pop();
    }
    const wsRe = /^\s*/;
    const lineParts = x.split('\n').map(s => {
        const ws = wsRe.exec(s)[0];
        return [ws, s.substr(ws.length)];
    });
    if (lineParts.length === 0) {
        return '';
    } // Reduce won't work well in this case
    // Calculate common whitespace only for non-empty lines
    const sharedWs = lineParts.reduce((commonWs, [ws, text]) => text !== '' ? commonPrefix(commonWs, ws) : commonWs, lineParts[0][0]);
    return lines.map(s => s.substr(sharedWs.length)).join('\n');
}
/**
 * Use object hackery to get the credentials out of the SDK object
 */
function sdkConfig(sdk) {
    return sdk.config;
}
function commonPrefix(a, b) {
    const N = Math.min(a.length, b.length);
    for (let i = 0; i < N; i++) {
        if (a[i] !== b[i]) {
            return a.substring(0, i);
        }
    }
    return a.substr(N);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2RrLXByb3ZpZGVyLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZGstcHJvdmlkZXIudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlDQUF5QztBQUN6QywrQkFBK0I7QUFDL0Isd0NBQXdDO0FBRXhDLDZCQUE2QjtBQUM3QixtQ0FBdUM7QUFDdkMscURBQWlFO0FBQ2pFLDZDQUE2QztBQUM3QyxvQ0FBb0M7QUFFcEMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUM1QixPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBSXpCLE1BQU0sa0JBQWtCLEdBQUc7SUFDekIsUUFBUSxFQUFFLEtBQUs7SUFDZixjQUFjLEVBQUUsS0FBSztDQUN0QixDQUFDO0FBRUYsdUJBQXVCO0FBQ3ZCLElBQUksR0FBVyxDQUFDO0FBQ2hCLElBQUksYUFBYSxHQUFHLEtBQUssQ0FBQztBQUUxQixVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUM7SUFFdkIsTUFBTSxDQUFDO1FBQ0wsMkJBQTJCLEVBQUUsTUFBTSxDQUFDOzswQkFFZCxHQUFHOzs7OzBCQUlILEdBQUc7Ozs7MEJBSUgsR0FBRzs7S0FFeEIsQ0FBQztRQUNGLHNCQUFzQixFQUFFLE1BQU0sQ0FBQzs7Ozs7Ozs7MEJBUVQsR0FBRzs7Ozs7Ozs7OztLQVV4QixDQUFDO0tBQ0gsQ0FBQyxDQUFDO0lBRUgsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyxFQUFrRCxFQUFFLEVBQUU7UUFDOUYsT0FBTyxFQUFFLENBQUMsSUFBSSxFQUFFO1lBQ2QsT0FBTyxFQUFFLEdBQUcsR0FBRyxlQUFlO1lBQzlCLE1BQU0sRUFBRSxNQUFNO1lBQ2QsR0FBRyxFQUFFLG1DQUFtQztTQUN6QyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILGdCQUFVLENBQUMsUUFBUSxDQUFDLHlCQUF5QixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN4RCxnQkFBVSxDQUFDLFFBQVEsQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLENBQUM7UUFDakQsV0FBVyxLQUFLLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0MscUJBQXFCLENBQUMsT0FBTyxJQUFJLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEtBQUssR0FBRyxHQUFHLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hHLFdBQVc7WUFDVCxhQUFhLEdBQUcsSUFBSSxDQUFDO1lBQ3JCLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxXQUFXLENBQUM7Z0JBQ3pDLFdBQVcsRUFBRSxHQUFHLEdBQUcsWUFBWTtnQkFDL0IsZUFBZSxFQUFFLGVBQWU7Z0JBQ2hDLFlBQVksRUFBRSxjQUFjO2FBQzdCLENBQUMsQ0FBQyxDQUFDO1FBQ04sQ0FBQztRQUNELElBQUksRUFBRSxhQUFhO0tBQ3BCLENBQUMsQ0FBQztJQUVILHlDQUF5QztJQUN6QyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUM7SUFDbEUsT0FBTyxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLENBQUM7SUFDbkYsd0hBQXdIO0lBQ3hILE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7SUFDOUIsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDO0lBQ3RDLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQztJQUNyQyxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUM7SUFDekMsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDO0FBQ3ZDLENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtJQUNiLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNsQixNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDbkIsQ0FBQyxDQUFDLENBQUM7QUFFSCxRQUFRLENBQUMsb0NBQW9DLEVBQUUsR0FBRyxFQUFFO0lBQ2xELElBQUksQ0FBQyw0QkFBNEIsRUFBRSxLQUFLLElBQUksRUFBRTtRQUM1QyxPQUFPO1FBQ1AsTUFBTSxRQUFRLEdBQUcsTUFBTSxzQkFBVyxDQUFDLDRCQUE0QixDQUFDLEVBQUUsR0FBRyxrQkFBa0IsRUFBRSxDQUFDLENBQUM7UUFFM0YsT0FBTztRQUNQLE1BQU0sQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ25ELE1BQU0sTUFBTSxDQUFDLFFBQVEsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxTQUFTLEVBQUUsR0FBRyxHQUFHLGVBQWUsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQztRQUN0SCxNQUFNLEdBQUcsR0FBRyxNQUFNLFFBQVEsQ0FBQyxjQUFjLENBQUMsR0FBRyxHQUFHLGVBQWUsRUFBRSxLQUFLLEVBQUUsZUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3pGLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsV0FBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEdBQUcsUUFBUSxDQUFDLENBQUM7UUFDeEUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDL0MsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMseUNBQXlDLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDekQsT0FBTztRQUNQLE1BQU0sUUFBUSxHQUFHLE1BQU0sc0JBQVcsQ0FBQyw0QkFBNEIsQ0FBQyxFQUFFLEdBQUcsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO1FBRTNGLE9BQU87UUFDUCxNQUFNLEdBQUcsR0FBRyxNQUFNLFFBQVEsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxLQUFLLENBQUMsY0FBYyxFQUFFLGVBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN4RyxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFdBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxDQUFDO1FBQ3hFLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3BELENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLDJCQUEyQixFQUFFLEtBQUssSUFBSSxFQUFFO1FBQzNDLE9BQU87UUFDUCxNQUFNLFFBQVEsR0FBRyxNQUFNLHNCQUFXLENBQUMsNEJBQTRCLENBQUMsRUFBRSxHQUFHLGtCQUFrQixFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBRTNHLE9BQU87UUFDUCxNQUFNLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNwRCxNQUFNLE1BQU0sQ0FBQyxRQUFRLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsU0FBUyxFQUFFLEdBQUcsR0FBRyxlQUFlLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7UUFDdEgsTUFBTSxHQUFHLEdBQUcsTUFBTSxRQUFRLENBQUMsY0FBYyxDQUFDLEdBQUcsR0FBRyxlQUFlLEVBQUUsS0FBSyxFQUFFLGVBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN6RixNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFdBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLFVBQVUsQ0FBQyxDQUFDO0lBQzVFLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLHlCQUF5QixFQUFFLEtBQUssSUFBSSxFQUFFO1FBQ3pDLE9BQU87UUFDUCxNQUFNLFFBQVEsR0FBRyxNQUFNLHNCQUFXLENBQUMsNEJBQTRCLENBQUMsRUFBRSxHQUFHLGtCQUFrQixFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBRTNHLE9BQU87UUFDUCxNQUFNLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFFLDhCQUE4QjtRQUNuRixNQUFNLE1BQU0sQ0FBQyxRQUFRLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsU0FBUyxFQUFFLEdBQUcsR0FBRyxlQUFlLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7UUFDdEgsTUFBTSxHQUFHLEdBQUcsTUFBTSxRQUFRLENBQUMsY0FBYyxDQUFDLEdBQUcsR0FBRyxlQUFlLEVBQUUsS0FBSyxFQUFFLGVBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN6RixNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFdBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLFVBQVUsQ0FBQyxDQUFDO0lBQzVFLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLDBCQUEwQixFQUFFLEtBQUssSUFBSSxFQUFFO1FBQzFDLE1BQU0sUUFBUSxHQUFHLE1BQU0sc0JBQVcsQ0FBQyw0QkFBNEIsQ0FBQyxFQUFFLEdBQUcsa0JBQWtCLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFFM0csTUFBTSxNQUFNLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxHQUFHLEdBQUcsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLGVBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsMkJBQTJCLENBQUMsQ0FBQztJQUNySSxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyx1RkFBdUYsRUFBRSxLQUFLLElBQUksRUFBRTtRQUN2RyxnQkFBZ0I7UUFDaEIsSUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEdBQUcsRUFBRTtZQUM1QixpRUFBaUU7WUFDakUsTUFBTSxTQUFVLFNBQVEsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUs7Z0JBQ3JDLFVBQVUsQ0FBQyxDQUFNLEVBQUUsRUFBTztvQkFDL0IsaUVBQWlFO29CQUNqRSxxRUFBcUU7b0JBQ3JFLHNFQUFzRTtvQkFDdEUsc0VBQXNFO29CQUN0RSxZQUFZO29CQUNaLE1BQU0sS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUM7b0JBQzFDLEtBQWEsQ0FBQyxJQUFJLEdBQUcscUJBQXFCLENBQUM7b0JBQzNDLEtBQWEsQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO29CQUNqQyxNQUFNLEdBQUcsSUFBSSxDQUFDO29CQUNkLE1BQU0sS0FBSyxDQUFDO2dCQUNkLENBQUM7YUFDRjtZQUNELE9BQU8sU0FBUyxDQUFDO1FBQ25CLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTztRQUNQLE1BQU0sUUFBUSxHQUFHLE1BQU0sc0JBQVcsQ0FBQyw0QkFBNEIsQ0FBQyxFQUFFLEdBQUcsa0JBQWtCO1lBQ3JGLFFBQVEsRUFBRSxLQUFLO1lBQ2YsT0FBTyxFQUFFLFdBQVc7WUFDcEIsV0FBVyxFQUFFO2dCQUNYLFlBQVksRUFBRSxzQkFBc0I7YUFDckM7U0FDRixDQUFDLENBQUM7UUFFSCxNQUFNLFFBQVEsQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUVoQywwRUFBMEU7UUFDMUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLFNBQVMsRUFBRSxHQUFHLEVBQUU7SUFDdkIsSUFBSSxDQUFDLHNFQUFzRSxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQ3RGLE1BQU0sUUFBUSxHQUFHLE1BQU0sc0JBQVcsQ0FBQyw0QkFBNEIsQ0FBQyxFQUFFLEdBQUcsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO1FBQzNGLE1BQU0sUUFBUSxDQUFDLGNBQWMsQ0FBQyxHQUFHLEdBQUcsZUFBZSxFQUFFLEtBQUssRUFBRSxlQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDN0UsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN2QyxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQywrQkFBK0IsRUFBRSxLQUFLLElBQUksRUFBRTtRQUMvQyxNQUFNLFFBQVEsR0FBRyxNQUFNLHNCQUFXLENBQUMsNEJBQTRCLENBQUMsRUFBRSxHQUFHLGtCQUFrQixFQUFFLENBQUMsQ0FBQztRQUMzRixNQUFNLFFBQVEsQ0FBQyxjQUFjLENBQUMsR0FBRyxHQUFHLGtCQUFrQixFQUFFLEtBQUssRUFBRSxlQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDaEYsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUg7O0dBRUc7QUFDSCxTQUFTLE1BQU0sQ0FBQyxDQUFTO0lBQ3ZCLE1BQU0sS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUIsT0FBTyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFO1FBQUUsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO0tBQUU7SUFDckUsT0FBTyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUU7UUFBRSxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUM7S0FBRTtJQUVsRixNQUFNLElBQUksR0FBRyxNQUFNLENBQUM7SUFDcEIsTUFBTSxTQUFTLEdBQTRCLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQy9ELE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUIsT0FBTyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ25DLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUFFLE9BQU8sRUFBRSxDQUFDO0tBQUUsQ0FBRSxzQ0FBc0M7SUFFbEYsdURBQXVEO0lBQ3ZELE1BQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFnQixFQUFFLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDMUksT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDOUQsQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBUyxTQUFTLENBQUMsR0FBUztJQUMxQixPQUFRLEdBQVcsQ0FBQyxNQUFNLENBQUM7QUFDN0IsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLENBQVMsRUFBRSxDQUFTO0lBQ3hDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdkMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUMxQixJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFBRSxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQUU7S0FDakQ7SUFDRCxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDckIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGN4YXBpIGZyb20gJ0Bhd3MtY2RrL2N4LWFwaSc7XG5pbXBvcnQgKiBhcyBBV1MgZnJvbSAnYXdzLXNkayc7XG5pbXBvcnQgKiBhcyBTREtNb2NrIGZyb20gJ2F3cy1zZGstbW9jayc7XG5pbXBvcnQgeyBDb25maWd1cmF0aW9uT3B0aW9ucyB9IGZyb20gJ2F3cy1zZGsvbGliL2NvbmZpZyc7XG5pbXBvcnQgKiBhcyB1dWlkIGZyb20gJ3V1aWQnO1xuaW1wb3J0IHsgUGx1Z2luSG9zdCB9IGZyb20gJy4uLy4uL2xpYic7XG5pbXBvcnQgeyBJU0RLLCBNb2RlLCBTZGtQcm92aWRlciB9IGZyb20gJy4uLy4uL2xpYi9hcGkvYXdzLWF1dGgnO1xuaW1wb3J0ICogYXMgbG9nZ2luZyBmcm9tICcuLi8uLi9saWIvbG9nZ2luZyc7XG5pbXBvcnQgKiBhcyBib2NrZnMgZnJvbSAnLi4vYm9ja2ZzJztcblxuU0RLTW9jay5zZXRTREtJbnN0YW5jZShBV1MpO1xubG9nZ2luZy5zZXRWZXJib3NlKHRydWUpO1xuXG50eXBlIEF3c0NhbGxiYWNrPFQ+ID0gKGVycjogRXJyb3IgfCBudWxsLCB2YWw6IFQpID0+IHZvaWQ7XG5cbmNvbnN0IGRlZmF1bHRDcmVkT3B0aW9ucyA9IHtcbiAgZWMyY3JlZHM6IGZhbHNlLFxuICBjb250YWluZXJDcmVkczogZmFsc2UsXG59O1xuXG4vLyBBY2NvdW50IGNhY2hlIGJ1c3RlclxubGV0IHVpZDogc3RyaW5nO1xubGV0IHBsdWdpblF1ZXJpZWQgPSBmYWxzZTtcblxuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIHVpZCA9IGAoJHt1dWlkLnY0KCl9KWA7XG5cbiAgYm9ja2ZzKHtcbiAgICAnL2hvbWUvbWUvLmJ4dC9jcmVkZW50aWFscyc6IGRlZGVudChgXG4gICAgICBbZGVmYXVsdF1cbiAgICAgIGF3c19hY2Nlc3Nfa2V5X2lkPSR7dWlkfWFjY2Vzc1xuICAgICAgYXdzX3NlY3JldF9hY2Nlc3Nfa2V5PXNlY3JldFxuXG4gICAgICBbZm9vXVxuICAgICAgYXdzX2FjY2Vzc19rZXlfaWQ9JHt1aWR9Zm9vY2Nlc3NcbiAgICAgIGF3c19zZWNyZXRfYWNjZXNzX2tleT1zZWNyZXRcblxuICAgICAgW2Fzc3VtZXJdXG4gICAgICBhd3NfYWNjZXNzX2tleV9pZD0ke3VpZH1hc3N1bWVyXG4gICAgICBhd3Nfc2VjcmV0X2FjY2Vzc19rZXk9c2VjcmV0XG4gICAgYCksXG4gICAgJy9ob21lL21lLy5ieHQvY29uZmlnJzogZGVkZW50KGBcbiAgICAgIFtkZWZhdWx0XVxuICAgICAgcmVnaW9uPWV1LWJsYS01XG5cbiAgICAgIFtwcm9maWxlIGZvb11cbiAgICAgIHJlZ2lvbj1ldS13ZXN0LTFcblxuICAgICAgW3Byb2ZpbGUgYm9vXVxuICAgICAgYXdzX2FjY2Vzc19rZXlfaWQ9JHt1aWR9Ym9vY2Nlc3NcbiAgICAgIGF3c19zZWNyZXRfYWNjZXNzX2tleT1ib29jcmV0XG4gICAgICAjIE5vIHJlZ2lvbiBoZXJlXG5cbiAgICAgIFtwcm9maWxlIGFzc3VtYWJsZV1cbiAgICAgIHJvbGVfYXJuPWFybjphd3M6aWFtOjoxMjM1Njc4OTAxMjpyb2xlL0Fzc3VtYWJsZVxuICAgICAgc291cmNlX3Byb2ZpbGU9YXNzdW1lclxuXG4gICAgICBbcHJvZmlsZSBhc3N1bWVyXVxuICAgICAgcmVnaW9uPXVzLWVhc3QtMlxuICAgIGApLFxuICB9KTtcblxuICBTREtNb2NrLm1vY2soJ1NUUycsICdnZXRDYWxsZXJJZGVudGl0eScsIChjYjogQXdzQ2FsbGJhY2s8QVdTLlNUUy5HZXRDYWxsZXJJZGVudGl0eVJlc3BvbnNlPikgPT4ge1xuICAgIHJldHVybiBjYihudWxsLCB7XG4gICAgICBBY2NvdW50OiBgJHt1aWR9dGhlX2FjY291bnRfI2AsXG4gICAgICBVc2VySWQ6ICd5b3UhJyxcbiAgICAgIEFybjogJ2Fybjphd3MtaGVyZTppYW06OjEyMzQ1OnJvbGUvdGVzdCdcbiAgICB9KTtcbiAgfSk7XG5cbiAgUGx1Z2luSG9zdC5pbnN0YW5jZS5jcmVkZW50aWFsUHJvdmlkZXJTb3VyY2VzLnNwbGljZSgwKTtcbiAgUGx1Z2luSG9zdC5pbnN0YW5jZS5jcmVkZW50aWFsUHJvdmlkZXJTb3VyY2VzLnB1c2goe1xuICAgIGlzQXZhaWxhYmxlKCkgeyByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRydWUpOyB9LFxuICAgIGNhblByb3ZpZGVDcmVkZW50aWFscyhhY2NvdW50KSB7IHJldHVybiBQcm9taXNlLnJlc29sdmUoYWNjb3VudCA9PT0gYCR7dWlkfXBsdWdpbl9hY2NvdW50XyNgKTsgfSxcbiAgICBnZXRQcm92aWRlcigpIHtcbiAgICAgIHBsdWdpblF1ZXJpZWQgPSB0cnVlO1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShuZXcgQVdTLkNyZWRlbnRpYWxzKHtcbiAgICAgICAgYWNjZXNzS2V5SWQ6IGAke3VpZH1wbHVnaW5fa2V5YCxcbiAgICAgICAgc2VjcmV0QWNjZXNzS2V5OiAncGx1Z2luX3NlY3JldCcsXG4gICAgICAgIHNlc3Npb25Ub2tlbjogJ3BsdWdpbl90b2tlbicsXG4gICAgICB9KSk7XG4gICAgfSxcbiAgICBuYW1lOiAndGVzdCBwbHVnaW4nLFxuICB9KTtcblxuICAvLyBTZXQgZW52aXJvbm1lbnQgdmFyaWFibGVzIHRoYXQgd2Ugd2FudFxuICBwcm9jZXNzLmVudi5BV1NfQ09ORklHX0ZJTEUgPSBib2NrZnMucGF0aCgnL2hvbWUvbWUvLmJ4dC9jb25maWcnKTtcbiAgcHJvY2Vzcy5lbnYuQVdTX1NIQVJFRF9DUkVERU5USUFMU19GSUxFID0gYm9ja2ZzLnBhdGgoJy9ob21lL21lLy5ieHQvY3JlZGVudGlhbHMnKTtcbiAgLy8gU2NydWIgc29tZSBlbnZpcm9ubWVudCB2YXJpYWJsZXMgdGhhdCBtaWdodCBiZSBzZXQgaWYgd2UncmUgcnVubmluZyBvbiBDb2RlQnVpbGQgd2hpY2ggd2lsbCBpbnRlcmZlcmUgd2l0aCB0aGUgdGVzdHMuXG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5BV1NfUkVHSU9OO1xuICBkZWxldGUgcHJvY2Vzcy5lbnYuQVdTX0RFRkFVTFRfUkVHSU9OO1xuICBkZWxldGUgcHJvY2Vzcy5lbnYuQVdTX0FDQ0VTU19LRVlfSUQ7XG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5BV1NfU0VDUkVUX0FDQ0VTU19LRVk7XG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5BV1NfU0VTU0lPTl9UT0tFTjtcbn0pO1xuXG5hZnRlckVhY2goKCkgPT4ge1xuICBTREtNb2NrLnJlc3RvcmUoKTtcbiAgYm9ja2ZzLnJlc3RvcmUoKTtcbn0pO1xuXG5kZXNjcmliZSgnQ0xJIGNvbXBhdGlibGUgY3JlZGVudGlhbHMgbG9hZGluZycsICgpID0+IHtcbiAgdGVzdCgnZGVmYXVsdCBjb25maWcgY3JlZGVudGlhbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7IC4uLmRlZmF1bHRDcmVkT3B0aW9ucyB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3QocHJvdmlkZXIuZGVmYXVsdFJlZ2lvbikudG9FcXVhbCgnZXUtYmxhLTUnKTtcbiAgICBhd2FpdCBleHBlY3QocHJvdmlkZXIuZGVmYXVsdEFjY291bnQoKSkucmVzb2x2ZXMudG9FcXVhbCh7IGFjY291bnRJZDogYCR7dWlkfXRoZV9hY2NvdW50XyNgLCBwYXJ0aXRpb246ICdhd3MtaGVyZScgfSk7XG4gICAgY29uc3Qgc2RrID0gYXdhaXQgcHJvdmlkZXIuZm9yRW52aXJvbm1lbnQoYCR7dWlkfXRoZV9hY2NvdW50XyNgLCAncmduJywgTW9kZS5Gb3JSZWFkaW5nKTtcbiAgICBleHBlY3Qoc2RrQ29uZmlnKHNkaykuY3JlZGVudGlhbHMhLmFjY2Vzc0tleUlkKS50b0VxdWFsKGAke3VpZH1hY2Nlc3NgKTtcbiAgICBleHBlY3Qoc2RrQ29uZmlnKHNkaykucmVnaW9uKS50b0VxdWFsKCdyZ24nKTtcbiAgfSk7XG5cbiAgdGVzdCgndW5rbm93biBhY2NvdW50IGFuZCByZWdpb24gdXNlcyBjdXJyZW50JywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoeyAuLi5kZWZhdWx0Q3JlZE9wdGlvbnMgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgY29uc3Qgc2RrID0gYXdhaXQgcHJvdmlkZXIuZm9yRW52aXJvbm1lbnQoY3hhcGkuVU5LTk9XTl9BQ0NPVU5ULCBjeGFwaS5VTktOT1dOX1JFR0lPTiwgTW9kZS5Gb3JSZWFkaW5nKTtcbiAgICBleHBlY3Qoc2RrQ29uZmlnKHNkaykuY3JlZGVudGlhbHMhLmFjY2Vzc0tleUlkKS50b0VxdWFsKGAke3VpZH1hY2Nlc3NgKTtcbiAgICBleHBlY3Qoc2RrQ29uZmlnKHNkaykucmVnaW9uKS50b0VxdWFsKCdldS1ibGEtNScpO1xuICB9KTtcblxuICB0ZXN0KCdtaXhlZCBwcm9maWxlIGNyZWRlbnRpYWxzJywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoeyAuLi5kZWZhdWx0Q3JlZE9wdGlvbnMsIHByb2ZpbGU6ICdmb28nIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChwcm92aWRlci5kZWZhdWx0UmVnaW9uKS50b0VxdWFsKCdldS13ZXN0LTEnKTtcbiAgICBhd2FpdCBleHBlY3QocHJvdmlkZXIuZGVmYXVsdEFjY291bnQoKSkucmVzb2x2ZXMudG9FcXVhbCh7IGFjY291bnRJZDogYCR7dWlkfXRoZV9hY2NvdW50XyNgLCBwYXJ0aXRpb246ICdhd3MtaGVyZScgfSk7XG4gICAgY29uc3Qgc2RrID0gYXdhaXQgcHJvdmlkZXIuZm9yRW52aXJvbm1lbnQoYCR7dWlkfXRoZV9hY2NvdW50XyNgLCAnZGVmJywgTW9kZS5Gb3JSZWFkaW5nKTtcbiAgICBleHBlY3Qoc2RrQ29uZmlnKHNkaykuY3JlZGVudGlhbHMhLmFjY2Vzc0tleUlkKS50b0VxdWFsKGAke3VpZH1mb29jY2Vzc2ApO1xuICB9KTtcblxuICB0ZXN0KCdwdXJlIGNvbmZpZyBjcmVkZW50aWFscycsIGFzeW5jICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHsgLi4uZGVmYXVsdENyZWRPcHRpb25zLCBwcm9maWxlOiAnYm9vJyB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3QocHJvdmlkZXIuZGVmYXVsdFJlZ2lvbikudG9FcXVhbCgnZXUtYmxhLTUnKTsgIC8vIEZhbGwgYmFjayB0byBkZWZhdWx0IGNvbmZpZ1xuICAgIGF3YWl0IGV4cGVjdChwcm92aWRlci5kZWZhdWx0QWNjb3VudCgpKS5yZXNvbHZlcy50b0VxdWFsKHsgYWNjb3VudElkOiBgJHt1aWR9dGhlX2FjY291bnRfI2AsIHBhcnRpdGlvbjogJ2F3cy1oZXJlJyB9KTtcbiAgICBjb25zdCBzZGsgPSBhd2FpdCBwcm92aWRlci5mb3JFbnZpcm9ubWVudChgJHt1aWR9dGhlX2FjY291bnRfI2AsICdkZWYnLCBNb2RlLkZvclJlYWRpbmcpO1xuICAgIGV4cGVjdChzZGtDb25maWcoc2RrKS5jcmVkZW50aWFscyEuYWNjZXNzS2V5SWQpLnRvRXF1YWwoYCR7dWlkfWJvb2NjZXNzYCk7XG4gIH0pO1xuXG4gIHRlc3QoJ2RpZmZlcmVudCBhY2NvdW50IHRocm93cycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoeyAuLi5kZWZhdWx0Q3JlZE9wdGlvbnMsIHByb2ZpbGU6ICdib28nIH0pO1xuXG4gICAgYXdhaXQgZXhwZWN0KHByb3ZpZGVyLmZvckVudmlyb25tZW50KGAke3VpZH1zb21lX2FjY291bnRfI2AsICdkZWYnLCBNb2RlLkZvclJlYWRpbmcpKS5yZWplY3RzLnRvVGhyb3coJ05lZWQgdG8gcGVyZm9ybSBBV1MgY2FsbHMnKTtcbiAgfSk7XG5cbiAgdGVzdCgnZXZlbiB3aGVuIHVzaW5nIGEgcHJvZmlsZSB0byBhc3N1bWUgYW5vdGhlciBwcm9maWxlLCBTVFMgY2FsbHMgZ29lcyB0aHJvdWdoIHRoZSBwcm94eScsIGFzeW5jICgpID0+IHtcbiAgICAvLyBNZXNzeSBtb2NraW5nXG4gICAgbGV0IGNhbGxlZCA9IGZhbHNlO1xuICAgIGplc3QubW9jaygncHJveHktYWdlbnQnLCAoKSA9PiB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXJlcXVpcmUtaW1wb3J0c1xuICAgICAgY2xhc3MgRmFrZUFnZW50IGV4dGVuZHMgcmVxdWlyZSgnaHR0cHMnKS5BZ2VudCB7XG4gICAgICAgIHB1YmxpYyBhZGRSZXF1ZXN0KF86IGFueSwgX186IGFueSkge1xuICAgICAgICAgIC8vIEZJWE1FOiB0aGlzIGVycm9yIHRha2VzIDYgc2Vjb25kcyB0byBiZSBjb21wbGV0ZWx5IGhhbmRsZWQuIEl0XG4gICAgICAgICAgLy8gbWlnaHQgYmUgcmV0cmllcyBpbiB0aGUgU0RLIHNvbWV3aGVyZSwgb3Igc29tZXRoaW5nIGFib3V0IHRoZSBOb2RlXG4gICAgICAgICAgLy8gZXZlbnQgbG9vcC4gSSd2ZSBzcGVudCBhbiBob3VyIHRyeWluZyB0byBmaWd1cmUgaXQgb3V0IGFuZCBJIGNhbid0LFxuICAgICAgICAgIC8vIGFuZCBJIGdhdmUgdXAuIFdlJ2xsIGp1c3QgaGF2ZSB0byBsaXZlIHdpdGggdGhpcyB1bnRpbCBzb21lb25lIGdldHNcbiAgICAgICAgICAvLyBpbnNwaXJlZC5cbiAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignQUJPUlRFRCBCWSBURVNUJyk7XG4gICAgICAgICAgKGVycm9yIGFzIGFueSkuY29kZSA9ICdSZXF1ZXN0QWJvcnRlZEVycm9yJztcbiAgICAgICAgICAoZXJyb3IgYXMgYW55KS5yZXRyeWFibGUgPSBmYWxzZTtcbiAgICAgICAgICBjYWxsZWQgPSB0cnVlO1xuICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gRmFrZUFnZW50O1xuICAgIH0pO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7IC4uLmRlZmF1bHRDcmVkT3B0aW9ucyxcbiAgICAgIGVjMmNyZWRzOiBmYWxzZSxcbiAgICAgIHByb2ZpbGU6ICdhc3N1bWFibGUnLFxuICAgICAgaHR0cE9wdGlvbnM6IHtcbiAgICAgICAgcHJveHlBZGRyZXNzOiAnaHR0cDovL0RPRVNOVE1BVFRFUi8nLFxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgYXdhaXQgcHJvdmlkZXIuZGVmYXVsdEFjY291bnQoKTtcblxuICAgIC8vIFRIRU4gLS0gdGhlIGZha2UgcHJveHkgYWdlbnQgZ290IGNhbGxlZCwgd2UgZG9uJ3QgY2FyZSBhYm91dCB0aGUgcmVzdWx0XG4gICAgZXhwZWN0KGNhbGxlZCkudG9FcXVhbCh0cnVlKTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ1BsdWdpbnMnLCAoKSA9PiB7XG4gIHRlc3QoJ2RvZXMgbm90IHVzZSBwbHVnaW5zIGlmIGN1cnJlbnQgY3JlZGVudGlhbHMgYXJlIGZvciBleHBlY3RlZCBhY2NvdW50JywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7IC4uLmRlZmF1bHRDcmVkT3B0aW9ucyB9KTtcbiAgICBhd2FpdCBwcm92aWRlci5mb3JFbnZpcm9ubWVudChgJHt1aWR9dGhlX2FjY291bnRfI2AsICdkZWYnLCBNb2RlLkZvclJlYWRpbmcpO1xuICAgIGV4cGVjdChwbHVnaW5RdWVyaWVkKS50b0VxdWFsKGZhbHNlKTtcbiAgfSk7XG5cbiAgdGVzdCgndXNlcyBwbHVnaW4gZm9yIG90aGVyIGFjY291bnQnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHsgLi4uZGVmYXVsdENyZWRPcHRpb25zIH0pO1xuICAgIGF3YWl0IHByb3ZpZGVyLmZvckVudmlyb25tZW50KGAke3VpZH1wbHVnaW5fYWNjb3VudF8jYCwgJ2RlZicsIE1vZGUuRm9yUmVhZGluZyk7XG4gICAgZXhwZWN0KHBsdWdpblF1ZXJpZWQpLnRvRXF1YWwodHJ1ZSk7XG4gIH0pO1xufSk7XG5cbi8qKlxuICogU3RyaXAgc2hhcmVkIHdoaXRlc3BhY2UgZnJvbSB0aGUgc3RhcnQgb2YgbGluZXNcbiAqL1xuZnVuY3Rpb24gZGVkZW50KHg6IHN0cmluZyk6IHN0cmluZyB7XG4gIGNvbnN0IGxpbmVzID0geC5zcGxpdCgnXFxuJyk7XG4gIHdoaWxlIChsaW5lcy5sZW5ndGggPiAwICYmIGxpbmVzWzBdLnRyaW0oKSA9PT0gJycpIHsgbGluZXMuc2hpZnQoKTsgfVxuICB3aGlsZSAobGluZXMubGVuZ3RoID4gMCAmJiBsaW5lc1tsaW5lcy5sZW5ndGggLSAxXS50cmltKCkgPT09ICcnKSB7IGxpbmVzLnBvcCgpOyB9XG5cbiAgY29uc3Qgd3NSZSA9IC9eXFxzKi87XG4gIGNvbnN0IGxpbmVQYXJ0czogQXJyYXk8W3N0cmluZywgc3RyaW5nXT4gPSB4LnNwbGl0KCdcXG4nKS5tYXAocyA9PiB7XG4gICAgY29uc3Qgd3MgPSB3c1JlLmV4ZWMocykhWzBdO1xuICAgIHJldHVybiBbd3MsIHMuc3Vic3RyKHdzLmxlbmd0aCldO1xuICB9KTtcblxuICBpZiAobGluZVBhcnRzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gJyc7IH0gIC8vIFJlZHVjZSB3b24ndCB3b3JrIHdlbGwgaW4gdGhpcyBjYXNlXG5cbiAgLy8gQ2FsY3VsYXRlIGNvbW1vbiB3aGl0ZXNwYWNlIG9ubHkgZm9yIG5vbi1lbXB0eSBsaW5lc1xuICBjb25zdCBzaGFyZWRXcyA9IGxpbmVQYXJ0cy5yZWR1Y2UoKGNvbW1vbldzOiBzdHJpbmcsIFt3cywgdGV4dF0pID0+IHRleHQgIT09ICcnID8gY29tbW9uUHJlZml4KGNvbW1vbldzLCB3cykgOiBjb21tb25XcywgbGluZVBhcnRzWzBdWzBdKTtcbiAgcmV0dXJuIGxpbmVzLm1hcChzID0+IHMuc3Vic3RyKHNoYXJlZFdzLmxlbmd0aCkpLmpvaW4oJ1xcbicpO1xufVxuXG4vKipcbiAqIFVzZSBvYmplY3QgaGFja2VyeSB0byBnZXQgdGhlIGNyZWRlbnRpYWxzIG91dCBvZiB0aGUgU0RLIG9iamVjdFxuICovXG5mdW5jdGlvbiBzZGtDb25maWcoc2RrOiBJU0RLKTogQ29uZmlndXJhdGlvbk9wdGlvbnMge1xuICByZXR1cm4gKHNkayBhcyBhbnkpLmNvbmZpZztcbn1cblxuZnVuY3Rpb24gY29tbW9uUHJlZml4KGE6IHN0cmluZywgYjogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgTiA9IE1hdGgubWluKGEubGVuZ3RoLCBiLmxlbmd0aCk7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgTjsgaSsrKSB7XG4gICAgaWYgKGFbaV0gIT09IGJbaV0pIHsgcmV0dXJuIGEuc3Vic3RyaW5nKDAsIGkpOyB9XG4gIH1cbiAgcmV0dXJuIGEuc3Vic3RyKE4pO1xufSJdfQ==